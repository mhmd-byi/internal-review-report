<!DOCTYPE html>

<html lang="en">
<head>
<meta charset="utf-8"/>
<title>Internal Review – Observation Template</title>
<style>

        :root{
            
            --font-heading: \"Bookman Old Style\", \"Times New Roman\", serif;
            --font-body: system-ui, -apple-system, \"Segoe UI\", Roboto, Arial, sans-serif;
--ui-primary: rgba(12, 74, 110, 0.95);
            --ui-primary-hover: rgba(7, 89, 133, 1);
            --ui-surface: rgba(255, 255, 255, 0.16);
            --ui-surface-solid: rgba(255, 255, 255, 0.92);
            --ui-stroke: rgba(255, 255, 255, 0.45);
            --ui-stroke-soft: rgba(203, 213, 225, 0.75);
            --ui-text: #111827;
            --ui-muted: #6b7280;
            --ui-shadow: 0 18px 35px rgba(15, 23, 42, 0.22);
            --ui-shadow-soft: 0 12px 25px rgba(15, 23, 42, 0.14);
            --ui-radius: 14px;
        }

body {
            font-family: var(--font-body);
            font-size: 12pt;
            background: radial-gradient(circle at top left, #e0f2fe 0, #f4f5f7 35%, #e5e7eb 100%);
            margin: 20px;
            padding-top: 40px;
            color: #222;
                text-align: justify;
}

        
        /* Typography pairing */
        .header-row h1,
        .area-heading,
        .dashboard-title,
        .meta-label,
        .obs-title-input {
            font-family: var(--font-heading);
        }
        .obs-title-input{
            line-height: 1.2;
        }
.page-wrapper {
            max-width: 1100px;
            margin: 0 auto 40px auto;
            padding-right: 48px;
        }

        /* Single-row header */
        .header-row {
            text-align: center;
            margin-top: 10px;
            margin-bottom: 6px;
        }

        .header-row h1 {
            margin: 4px 0 6px 0;
            font-size: 22pt;
            font-weight: 700;
        }

        .report-header {
            position: fixed;
            top: 0;
            right: 0;
            height: 100vh;
            width: 10mm;
            background: transparent;
            border-left: 1px solid #e5e7eb;
            color: #4b5563;
            font-size: 10pt;
            line-height: 1.15;
            padding: 8px 2px;
            text-align: center;
            writing-mode: vertical-rl;
            transform: rotate(180deg);
            z-index: 999;
            pointer-events: none;
        }
@media print {
            /* Preserve colours in PDF/Print */
            * { -webkit-print-color-adjust: exact; print-color-adjust: exact; }

            /* Right sidebar report header (print/PDF) */
            .report-header {
                position: fixed;
                top: 5mm;
                right: 0;
                height: calc(100% - 10mm);
                width: 10mm;
                background: transparent;
                padding: 6px 1px;
                margin: 0 !important;
                border-left: 1px solid #e5e7eb;
                border-bottom: none;
                font-size: 8pt;
                line-height: 1.1;
                text-align: center;
                writing-mode: vertical-rl;
                transform: rotate(180deg);
                z-index: 9999;
            }
body {
                margin: 5mm 10mm 5mm 5mm !important;
                padding-top: 14mm !important; /* room for fixed report header */
                padding-right: 0 !important;
                background: #ffffff !important;
            }
        }

        .glass-card {
            background: var(--ui-surface);
            border-radius: var(--ui-radius);
            border: 1px solid var(--ui-stroke);
            box-shadow: var(--ui-shadow), inset 0 1px 0 rgba(255,255,255,0.22), inset 0 0 0 1px rgba(255,255,255,0.18);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            position: relative;
        }

        /* subtle inner stroke for premium depth */
        .glass-card::before{
            content:"";
            position:absolute;
            inset:1px;
            border-radius: calc(var(--ui-radius) - 1px);
            border: 1px solid rgba(255,255,255,0.35);
            pointer-events:none;
        }

        .meta-header {
            padding: 16px 20px;
            margin-bottom: 18px;
            font-size: 14px;
        }

        .meta-header.glass-card {
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.18);
        }

        .meta-row {
            display: flex;
            flex-wrap: wrap;
            gap: 18px;
            margin-bottom: 6px;
        }

        .meta-item {
            min-width: 200px;
        }

        @media (min-width: 992px) {
            .meta-row {
                flex-wrap: nowrap;
                align-items: flex-end;
            }
            .meta-item {
                flex: 1 1 0;
                min-width: 0;
            }
            .meta-item.date-item {
                flex: 0 0 150px;
            }
        }

        .meta-label {
            font-weight: 600;
            margin-bottom: 4px;
        }

        .meta-input {
            width: 100%;
            padding: 6px 8px;
            border-radius: 8px;
            border: 1px solid #cbd5e1;
            font-size: 13px;
            box-sizing: border-box;
            background: rgba(255, 255, 255, 0.9);
        }

        .meta-input[type="date"] {
            padding: 5px 8px;
        }

        .toolbar {
            padding: 8px 12px;
            margin: 0 0 10px 0;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .toolbar.glass-card {
            box-shadow: 0 12px 25px rgba(15, 23, 42, 0.18);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .toolbar-counter {
            font-size: 10px;
            font-weight: 600;
            color: #f9fafb;
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.25);
            background: var(--ui-primary);
            box-shadow: 0 3px 6px rgba(15, 23, 42, 0.3);
            white-space: nowrap;
        }

        .toolbar-counter span {
            font-weight: 700;
        }

        .toolbar-location {
            font-size: 10px;
            font-weight: 600;
            color: #f9fafb;
            padding: 5px 10px;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.25);
            background: var(--ui-primary);
            box-shadow: 0 3px 6px rgba(15, 23, 42, 0.3);
            white-space: nowrap;
        }

        .toolbar-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: flex-end;
        }

        .toolbar button {
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: var(--ui-primary);
            color: #ffffff;
            cursor: pointer;
            letter-spacing: 0.02em;
        }

        .toolbar button:hover {
            background: var(--ui-primary-hover);
        }

        .shortcut-hint {
            font-size: 9px;
            margin-left: 4px;
            opacity: 0.8;
        }

        .collapse-toggle-global {
            font-size: 10px;
            padding: 4px 10px;
        }

        .toolbar-area-jump {
            font-size: 9px;
            display: flex;
            align-items: center;
            gap: 3px;
            padding: 2px 6px;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.18);
            background: rgba(22, 163, 74, 0.92);
            color: #f9fafb;
            white-space: nowrap;
        }

        .toolbar-area-jump select {
            font-size: 9px;
            border-radius: 999px;
            border: 1px solid rgba(240, 253, 244, 0.95);
            padding: 1px 6px;
            background: rgba(255,255,255,0.96);
            color: #111827;
            outline: none;
        
            width: 210px;
            max-width: 210px;
        }

        #printSummary {
            display: block;
            padding: 12px 14px;
            margin-bottom: 14px;
            font-size: 12px;
        }

        #printSummary.glass-card {
            background: transparent;
            box-shadow: none;
            border-radius: 8px;
        }

        #printSummary h3 {
            margin: 0 0 6px 0;
            font-size: 14px;
            color: #111827;
        }

        .summary-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 11px;
        }

        .summary-table th,
        .summary-table td {
            border: 1px solid #e5e7eb;
            padding: 3px 4px;
            text-align: left;
            vertical-align: middle;
        }

        .summary-table th {
            background: #f3f4f6;
            font-weight: 600;
        }
        /* Summary: area separators (no page breaks, just visual grouping) */
        .summary-area-row td{
            font-weight: 800;
            text-transform: uppercase;
            letter-spacing: 0.04em;
            font-size: 10px;
            padding: 6px 8px !important;
            border-top: 3px solid #111827 !important;
            border-bottom: 2px solid #111827 !important;
        }
        .summary-area-row[data-area="ICFM"] td{ background:#e0f2fe; }
        .summary-area-row[data-area="REV"] td{ background:#fff7ed; }
        .summary-area-row[data-area="EXP"] td{ background:#f0f9ff; }
        .summary-area-row[data-area="FA"] td{ background:#ecfdf5; }
        .summary-area-row[data-area="LEGAL"] td{ background:#fef2f2; }
        .summary-area-row[data-area="OTHER"] td{ background:#f3f4f6; }


        .page-separator {
            border: 0;
            border-top: 1px solid #e5e7eb;
            margin: 16px 0;
        }

        .area-section {
            margin-top: 18px;
        }

        .area-heading {
            font-size: 14px;
            font-weight: 700;
            margin: 0 0 8px 0;
            color: #111827;
        }

        .observation-divider {
            border: 0;
            border-top: 1px dashed #d1d5db;
            margin: 10px 0 12px 0;
        }

        .observation-card {
            margin-bottom: 10px;
            overflow: hidden;
            padding: 1px;
            width: 100%;
            box-sizing: border-box;
            page-break-inside: avoid;
            break-inside: avoid;
            position: relative;
        }

        
        /* Risk accent bar */
        .observation-card::before{
            content:"";
            position:absolute;
            left:0;
            top:0;
            bottom:0;
            width:6px;
            background: rgba(12,74,110,0.55);
            border-radius: 16px 0 0 16px;
            box-shadow: 2px 0 8px rgba(15, 23, 42, 0.28);
            pointer-events:none;
        }
        .observation-card.risk-high::before{ background:#b91c1c; }
        .observation-card.risk-medium::before{ background:#facc15; }
        .observation-card.risk-low::before{ background:#16a34a; }
        @media print{
            .observation-card::before{
                width:4px;
                border-radius: 10px 0 0 10px;
                box-shadow: 1px 0 4px rgba(15, 23, 42, 0.22);
            }
        }
.observation-card.glass-card {
            border-radius: 16px;
        }

        /* Keep observation card border neutral (avoid risk color tint) */
        .observation-card.glass-card{
            border-color: rgba(203, 213, 225, 0.9) !important;
        }

        .obs-header {
            display: flex;
            flex-direction: column;
            gap: 6px;
            padding: 10px 16px 8px 16px;
            background: linear-gradient(135deg, rgba(12, 74, 110, 0.92), rgba(15, 23, 42, 0.96));
            color: #ffffff;
        }

        .obs-title-block {
            width: 100%;
        }

        .obs-title-row {
            width: 100%;
        }

        .obs-title-box {
            width: 100%;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.55);
            background: rgba(15, 23, 42, 0.18);
            padding: 4px 6px;
            box-sizing: border-box;
        }

        .obs-title-input {
            width: 100%;
            resize: none;
            overflow: hidden;
            line-height: 1.2;
            border: none;
            background: transparent;
            color: #ffffff;
            font-size: 14px;
            font-weight: 600;
            padding: 0;
            margin: 0;
            outline: none;
            white-space: normal;
        }

        .obs-number-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
        }

        

        /* Observation No + Meta pills in one row (NA + Collapse kept as-is) */
        .obs-meta-row {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 4px;
            flex-wrap: nowrap;
        }
        .obs-meta-row .obs-number {
            flex: 0 0 auto;
            font-size: 11px;
            opacity: 0.9;
            white-space: nowrap;
            text-align: left;
        }
        .obs-meta-row .obs-meta-tags {
            flex: 1 1 auto;
            margin-top: 0;
            text-align: left;
        }
        .obs-meta-row .meta-inline {
            justify-content: flex-start;
            flex-wrap: nowrap;
            gap: 6px;
            overflow: hidden;
        }
        .obs-meta-row .meta-pill {
            white-space: nowrap;
        }
        .obs-meta-row .obs-right-group {
            flex: 0 0 auto;
        }

        @media (max-width: 700px) {
            .obs-meta-row { flex-wrap: wrap; }
            .obs-meta-row .meta-inline { flex-wrap: wrap; }
        }
.obs-number {
            flex: 1;
            font-size: 11px;
            opacity: 0.9;
            white-space: nowrap;
            text-align: left;
        }

        .obs-right-group {
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .na-toggle {
            font-size: 10px;
            color: #fefce8;
            display: inline-flex;
            align-items: center;
            gap: 4px;
            white-space: nowrap;
        }

        .na-toggle input[type="checkbox"] {
            margin: 0;
        }

        .obs-meta-tags {
            text-align: left;
            font-size: 11px;
            margin-top: 2px;
        }

        .meta-inline {
            display: flex;
            flex-wrap: nowrap;
            gap: 4px;
            align-items: center;
            justify-content: flex-start;
        }

        .meta-pill {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(15, 23, 42, 0.18);
            padding: 1px 5px;
            border-radius: 999px;
        
    white-space: nowrap;
}

        .meta-pill .tag-label {
            font-weight: 500;
            font-size: 10px;
        }

        .card-area-label {
            font-size: 10px;
            font-weight: 600;
        }

        .risk-dropdown {
            padding: 1px 4px;
            font-size: 10px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
        }

        .obs-type-select {
            padding: 1px 4px;
            font-size: 10px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background: transparent;
            color: #111827;
        }

        .fin-impact-input {
            width: 90px;
            padding: 1px 4px;
            font-size: 11px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background: transparent;
        }

        .collapse-toggle {
            border-radius: 999px;
            border: 1px solid rgba(255, 255, 255, 0.6);
            background: rgba(15, 23, 42, 0.25);
            padding: 2px 8px;
            font-size: 10px;
            color: #f9fafb;
            cursor: pointer;
            white-space: nowrap;
        }

        .obs-body {
            padding: 12px 16px 8px 16px;
            font-size: 13px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 0 0 14px 14px;
        }

        .observation-card.collapsed .obs-body {
            display: none;
        }

        .section-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
        }

        @media (min-width: 900px) {
            .section-grid-two {
                display: grid;
                grid-template-columns: 1.5fr 1fr;
                gap: 12px 18px;
            }
        }

        .field-block {
            background: rgba(249, 250, 251, 0.96);
            border-radius: 12px;
            padding: 10px 12px;
            border: 1px solid rgba(229, 231, 235, 0.9);
            box-shadow: 0 2px 10px rgba(15, 23, 42, 0.06);
        }

        .field-label {
            font-size: 11px;
            text-transform: uppercase;
            letter-spacing: 0.05em;
            color: #6b7280;
            font-weight: 700;
            margin-bottom: 3px;
        }

        .field-help {
            font-size: 11px;
            color: #9ca3af;
            margin-bottom: 4px;
        }

        .field-note {
            font-size: 10px;
            color: #9ca3af;
            margin-top: -2px;
            margin-bottom: 6px;
            font-style: italic;
        }

        .field-value,
        textarea,
        input,
        select {
            font-size: 13px;
            width: 100%;
            border: none;
            background: transparent;
            font-family: inherit;
            color: #111827;
        }

        textarea {
            min-height: 40px;
            resize: none;
            padding: 0;
            outline: none;
            overflow: hidden;
        }
        
        /* Print-friendly mirror for textarea content (prevents scrollbars/truncation in PDF) */
        .print-textarea-mirror {
            display: none;
            width: 100%;
            font-family: inherit;
            font-size: inherit;
            font-weight: inherit;
            color: inherit;
            background: transparent;
            white-space: pre-wrap;
            word-break: break-word;
        }

        @media print {
            /* Hide native textareas and show print mirrors */
            textarea {
                display: none !important;
            }
            .print-textarea-mirror {
                display: block !important;
            }
        }

.action-plan {
            min-height: 60px;
        }

        input[type="date"] {
            padding: 4px 6px;
            outline: none;
            background: transparent;
            border-radius: 4px;
            border: none;
            width: 100%;
        }

        .timeline-target {
            font-size: 13pt;
            font-weight: 700;
        }

        .status-select,
        .resp-select {
            padding: 4px 6px;
            border-radius: 6px;
            border: 1px solid #cbd5e1;
            background: transparent;
            width: 100%;
            outline: none;
            font-size: 13pt;
            font-weight: 700;
        }

        .small-columns {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        .small-col {
            flex: 1 1 200px;
        }

        .footer-note {
            font-size: 11px;
            color: #6b7280;
            margin-top: 4px;
        }

        .obs-separator {
            border-top: 1px dashed #d1d5db;
            margin: 8px 0;
        }

        .sub-field-label {
            font-size: 11px;
            font-weight: 600;
            color: #4b5563;
            margin: 6px 0 2px 0;
        }

        .narrow-block {
            max-width: 520px;
        }

        .dashboard {
            padding: 14px 18px 16px 18px;
            margin-top: 20px;
        }

        .dashboard.glass-card {
            border-radius: 18px;
        }

        .dashboard-intro {
            font-size: 11px;
            color: #4b5563;
            margin-bottom: 4px;
            font-style: italic;
        }

        .dashboard-header-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
        }

        .dashboard-title {
            font-size: 13px;
            font-weight: 700;
            color: #0f172a;
        }

        .dashboard-controls {
            font-size: 11px;
            color: #4b5563;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .dashboard-controls select {
            font-size: 11px;
            padding: 2px 4px;
            border-radius: 4px;
            border: 1px solid #cbd5e1;
            background: rgba(255,255,255,0.9);
        }

        .dash-refresh {
            padding: 3px 8px;
            font-size: 11px;
            border-radius: 999px;
            border: 1px solid rgba(15,23,42,0.25);
            background: rgba(255,255,255,0.85);
            cursor: pointer;
        }

        .dash-refresh:hover {
            background: #e5e7eb;
        }

        .kpi-row {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
        }

        .kpi-card {
            flex: 1 1 150px;
            padding: 8px 10px;
            border-radius: 12px;
            background: rgba(249, 250, 251, 0.92);
            border: 1px solid #e5e7eb;
        }

        .kpi-label {
            font-size: 11px;
            color: #6b7280;
        }

        .kpi-line {
            margin: 2px 0;
            font-size: 13px;
            font-weight: 600;
        }

        .kpi-value {
            font-size: 16px;
            font-weight: 700;
            color: #111827;
        }

        .kpi-subtext {
            font-size: 10px;
            color: #6b7280;
        }

        #kpiFinImpactTotal {
            font-size: 16pt;
            font-weight: bold;
            text-decoration: underline;
        }

        .dashboard-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
        }

        .dashboard-grid.charts-row {
            display: grid;
            grid-template-columns: repeat(4, minmax(0, 1fr));
            align-items: stretch;
        }

        .dashboard-grid.charts-row .dashboard-block {
            flex: 0 0 auto;
        }

        .dashboard-grid.charts-row .matrix-card {
            height: 100%;
        }

        .dashboard-block {
            flex: 1 1 230px;
        }

        .dashboard-block h4 {
            font-size: 12px;
            margin: 0 0 4px 0;
            color: #374151;
        }

        .chart-container {
            max-width: 180px;
        }

        .chart-legend {
            font-size: 10px;
            margin-top: 4px;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 4px;
            margin-bottom: 1px;
        }

        .legend-color {
            width: 9px;
            height: 9px;
            border-radius: 2px;
            display: inline-block;
        }

        .chip-row {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin-top: 6px;
            font-size: 10.5px;
        }

        .chip {
            border-radius: 999px;
            padding: 3px 8px;
            border: 1px solid transparent;
        }

        .chip-ok {
            background: #ecfdf3;
            border-color: #22c55e;
            color: #166534;
        }

        .chip-warn {
            background: #fffbeb;
            border-color: #fbbf24;
            color: #92400e;
        }

        .chip-bad {
            background: #fef2f2;
            border-color: #ef4444;
            color: #b91c1c;
        }

        .audit-info {
            margin-top: 6px;
            font-size: 10px;
            color: #6b7280;
            display: flex;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 6px;
        }

        .timeline-table {
            table-layout: fixed;
        }

        .timeline-table th:nth-child(1) { width: 10%; }
        .timeline-table th:nth-child(2) { width: 16%; }
        .timeline-table th:nth-child(3) { width: 14%; }
        .timeline-table th:nth-child(4) { width: 15%; }
        .timeline-table th:nth-child(5) { width: 15%; }
        .timeline-table th:nth-child(6) { width: 30%; }

        .timeline-table td {
            word-wrap: break-word;
            white-space: normal;
        }

        .timeline-bar-outer {
            position: relative;
            height: 18px;
            background: #e5e7eb;
            border-radius: 999px;
            overflow: hidden;
        }

        .timeline-bar-inner {
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
        }

        .timeline-bar-label {
            position: absolute;
            inset: 0;
            font-size: 10px;
            text-align: center;
            line-height: 18px;
            color: #111827;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .timeline-link{
            display:block;
            text-decoration:none;
            color: inherit;
            cursor: inherit;
        }
        .timeline-link:visited{ color: inherit; }



        .legend-note {
            font-size: 10px;
            color: #6b7280;
            margin-top: 4px;
        }

        .legend-swatch {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 2px;
            margin-right: 3px;
            vertical-align: middle;
        }

        #expiryWarning {
            font-size: 11px;
        }

        .matrix-card {
            background: rgba(249, 250, 251, 0.96);
            border-radius: 12px;
            border: 1px solid #d1d5db;
            padding: 8px 10px;
            box-shadow: 0 4px 10px rgba(15, 23, 42, 0.12);
            margin-bottom: 8px;
        }

        .locked-field {
            background: #f3f4f6 !important;
            color: #6b7280 !important;
            border-color: #d1d5db !important;
        }

        .editable-field {
            border-width: 3px !important;
            border-style: solid !important;
            background: #ffffff !important;
            box-shadow: 0 0 0 2px rgba(148, 163, 184, 0.4);
            transition:
                box-shadow 0.18s ease-out,
                transform 0.18s ease-out,
                background-color 0.18s ease-out;
        }

        .editable-field:hover {
            box-shadow: 0 0 0 3px rgba(15, 23, 42, 0.35);
            transform: translateY(-1px);
            background-color: #f9fafb !important;
        }

        .status-open {
            background: #F1ECF7;
            border: 2px solid #8F7EA5;
            color: #5E4E78;
        }

        .status-inprogress {
            background: #F4ECE6;
            border: 2px solid #6A4F3A;
            color: #4E3A2A;
        }

        .status-closed {
            background: #E8F1EE;
            border: 2px solid #5A7F71;
            color: #3F594E;
        }

        .status-icon {
            display: inline-block;
            width: 12px;
            height: 12px;
            margin-right: 4px;
            vertical-align: middle;
        }

        .status-open-icon {
            background: #8F7EA5;
            clip-path: polygon(
                25% 0%,
                75% 0%,
                100% 50%,
                75% 100%,
                25% 100%,
                0% 50%
            );
        }

        .status-inprogress-icon {
            background: #6A4F3A;
            border-radius: 50%;
        }

        .status-closed-icon {
            background: #5A7F71;
            clip-path: polygon(
                50% 0%,
                100% 38%,
                82% 100%,
                18% 100%,
                0% 38%
            );
        }

        @media print {
            .glass-card::before{display:none !important;}
            body {
                margin: 5mm 10mm 5mm 5mm !important;
                padding-top: 0;
                background: #ffffff !important;
                box-sizing: border-box;
                font-size: 10pt;
            }

            .toolbar {
                display:flex !important;
                flex-wrap:nowrap !important;
                justify-content:space-between;
                align-items:center;
                gap:6px;
                padding:4px 6px;
                }

            .header-row {
                display: none !important;
            }

            .page-wrapper {
                margin: 0;
                max-width: 100%;
            }

            .observation-card {
                box-shadow: none;
                background: transparent;
            }

            .observation-card.na-card {
                display: none !important;
            }

            .na-toggle,
            .collapse-toggle {
                display: none !important;
            }

            .meta-header,
            #printSummary,
            .dashboard,
            .field-block {
                box-shadow: none !important;
                background: #ffffff !important;
            }

            .obs-body {
                padding: 8px 10px;
            }

            .field-block {
                padding: 6px 8px;
            }

            .dashboard {
                page-break-before: auto;
                page-break-inside: avoid;
            }
        }
    
        .section-progress-wrapper {
            margin: 4px 0 6px 0;
            font-size: 10px;
            color: #4b5563;
        }
        .section-progress-bar-outer {
            width: 100%;
            height: 6px;
            border-radius: 999px;
            background: #e5e7eb;
            overflow: hidden;
        }
        .section-progress-bar-inner {
            height: 100%;
            width: 0;
            border-radius: 999px;
            background: linear-gradient(90deg, #16a34a, #22c55e);
            transition: width 0.25s ease-out;
        }
        .section-progress-label {
            margin-top: 2px;
            font-size: 10px;
            color: #6b7280;
        }

    
        .management-view-toggle {
            padding: 6px 12px;
            font-size: 11px;
            border-radius: 999px;
            border: 1px solid rgba(15, 23, 42, 0.2);
            background: rgba(15, 23, 42, 0.85);
            color: #ffffff;
            cursor: pointer;
            letter-spacing: 0.02em;
        }
        body.mgmt-view .obs-body {
            display: none;
        }
        body.mgmt-view .review-notes {
            display: block;
        }
        body.mgmt-view .collapse-toggle {
            display: none;
        }
        body.mgmt-view .na-toggle {
            display: none;
        }

    
    @media print {
        .review-notes {
            display: none !important;
        }
        /* NOTE: obs-body must remain visible in print/PDF so Management Response and filled text are captured */
    }

/* --- UI polish: ensure Type & Impact fields stay white in header pills --- */
.obs-type-select,
.fin-impact-input {
    background: #ffffff !important;
    color: #111827 !important;
}
/* Area dropdown matches the same clean style */
.area-select {
    padding: 1px 4px;
    font-size: 10px;
    border-radius: 6px;
    border: 1px solid #cbd5e1;
    background: #ffffff !important;
    color: #111827 !important;
}



/* Dynamic multi-line title field */
textarea.obs-title-input{
    width:100%;
    border:none;
    background:transparent;
    color:#ffffff;
    font-size:14px;
    font-weight:600;
    padding:0;
    margin:0;
    outline:none;
    resize:none;
    overflow:hidden;
    line-height:1.25;
    min-height:18px;
}

        /* Ensure dynamic title textarea prints fully (no clipping) */
        @media print {
            .obs-title-box { height: auto !important; }
            .obs-title-input {
                height: auto !important;
                overflow: visible !important;
                white-space: pre-wrap !important;
                resize: none !important;
            }
        }


/* --- Cosmetic/print fixes v21 --- */
#metaAuditDate { background: #ffffff !important; color: #111827 !important; }
.meta-date-display { font-size: 11px; color: #4b5563; margin-top: 2px; line-height: 1.15; }

/* Reviewer notes spacing (avoid overlap) */
.review-notes {
    display: block;
    width: 100%;
    margin-top: 12px;
    padding: 8px 10px;
    border-radius: 10px;
    border: 1px dashed #cbd5e1;
    background: rgba(249, 250, 251, 0.95);
    box-sizing: border-box;
}

/* Ensure printed audit date is formatted text, not ISO from date input */
@media print {
    #metaAuditDate { display: none !important; }
    #metaAuditDateDisplay { display: block !important; }
}


        @media print {
            /* Remove all interactive buttons/controls for clean PDF */
            .toolbar { display: none !important; }
            .toolbar * { display: none !important; }
            button { display: none !important; }
        }


/* Reviewer Notes: show only when card is collapsed (screen only) */
.review-notes-wrap { margin: 8px 16px 10px 16px; }
.observation-card .review-notes-wrap { display: none; }
.observation-card.collapsed .review-notes-wrap { display: block; }
@media print { .review-notes-wrap { display: none !important; } }


@media print {
  /* Meta row hidden in print/PDF (covered by right sidebar header) */
  .meta-header { display: none !important; }
}



/* --- Dashboard print layout upgrades (A4 portrait) --- */
@media print {
  /* Charts: smaller + 2 columns so they fit portrait */
  .dashboard-grid.charts-row {
    display: grid !important;
    grid-template-columns: repeat(2, minmax(0, 1fr)) !important;
    gap: 8px !important;
  }
  .dashboard-grid.charts-row .chart-container { max-width: 140px !important; }
  .dashboard-grid.charts-row canvas {
    width: 115px !important;
    height: 115px !important;
  }

  /* Two-card rows in dashboard: keep same row + same height */
  .dashboard-grid.pair-row {
    display: grid !important;
    grid-template-columns: 1fr 1fr !important;
    gap: 10px !important;
    align-items: stretch !important;
  }
  .dashboard-grid.pair-row .dashboard-block { height: 100% !important; }
  .dashboard-grid.pair-row .matrix-card { height: 100% !important; }

  /* Avoid awkward splits */
  .matrix-card, .dashboard, .dashboard-block { break-inside: avoid; page-break-inside: avoid; }
}


/* Dashboard tweaks (non-intrusive) */
.area-risk-matrix .total-col { font-weight: 700; }
.area-risk-matrix tr.grand-total-row td,
.area-risk-matrix tr.grand-total-row th { font-weight: 700; }


/* ===== DEMO: Vertical left toolbar (no functional changes) ===== */
.demo-vertical-toolbar .toolbar{
  position: fixed;
  left: 0;
  top: 0;
  width: 180px;
  height: 100vh;
  flex-direction: column;
  align-items: stretch;
  justify-content: flex-start;
  gap: 8px;
  padding: 8px 8px;
  margin: 0;
  border-radius: 0;
}
.demo-vertical-toolbar .toolbar-left,
.demo-vertical-toolbar .toolbar-actions{
  display: flex;
  flex-direction: column;
  align-items: stretch;
  gap: 8px;
}
.demo-vertical-toolbar .toolbar-left > div{
  width: 100%;
}
.demo-vertical-toolbar .toolbar-left button,
.demo-vertical-toolbar .toolbar-actions button{
  width: 100%;
  justify-content: center;
  padding: 6px 6px;
  font-size: 12px;
}
.demo-vertical-toolbar .shortcut-hint{ display:none !important; }
.demo-vertical-toolbar .toolbar-area-jump select{
  width: 100%;
}
.demo-vertical-toolbar .page-wrapper{
  margin-left: 195px;
}
@media print{
  .demo-vertical-toolbar .toolbar{ display:none !important; }
  .demo-vertical-toolbar .page-wrapper{ margin-left: 0 !important; }
}
</style>
</head>
<body class="demo-vertical-toolbar" onload="initialiseTemplate()">
<div class="page-wrapper">
<div class="report-header" id="reportHeader"></div>
<!-- Single-row main title -->
<div class="header-row">
<h1>Internal Review Report – Observation Summary Template</h1>
</div>
<div class="legend-note" id="expiryWarning" style="text-align:center; font-weight:600;"></div>
<!-- META -->
<div class="meta-header glass-card">
<div class="meta-row">
<div class="meta-item">
<div class="meta-label">School</div>
<input class="meta-input" id="metaSchoolName" type="text" value="MSB School"/>
</div>
<div class="meta-item">
<div class="meta-label">Location</div>
<input class="meta-input" id="metaLocation" type="text" value="Rajkot"/>
</div>
<div class="meta-item">
<div class="meta-label">Period of Review</div>
<input class="meta-input" id="metaPeriod" type="text" value="01-Apr-2024 to 31-Jan-2025"/>
</div>
<div class="meta-item date-item">
<div class="meta-label">Date of Audit</div>
<input class="meta-input" id="metaAuditDate" type="date"/>
</div>
<div class="meta-item">
<div class="meta-label">Prepared By</div>
<input class="meta-input" id="metaPreparedBy" type="text" value="Internal Audit Team"/>
</div>
</div>
</div>
<!-- TOOLBAR -->
<div class="toolbar glass-card">
<div class="toolbar-left">
<div class="legend-note" style="margin:0; padding:8px 10px; font-size:11px; text-align:left;">
<b>Demo:</b> Buttons arranged vertically on the left margin (layout test only).
</div>
<div class="toolbar-counter">
                Obs: <span id="obsCounter">1</span>
</div>
<div class="toolbar-location">
                Location: <span id="toolbarLocation">Rajkot</span>
</div>
<!-- Area jump dropdown -->
<div class="toolbar-area-jump">Jump To:
                <select id="jumpUnified"></select>
</div>
<button onclick="scrollToSummary()" type="button">Go to Summary</button>
<button onclick="scrollToDashboard()" type="button">Go to Dashboard</button>
<button class="collapse-toggle collapse-toggle-global" id="btnToggleAllObs" type="button">Collapse all</button>
</div>
<div class="toolbar-actions">
<button onclick="addObservationCard()" type="button">
                Add Observation <span class="shortcut-hint">(Ctrl+Shift+A)</span>
</button>
<button onclick="exportToPDF()" type="button">
                Export to PDF <span class="shortcut-hint">(Ctrl+Shift+P)</span>
</button>
<button onclick="exportToWord()" type="button">Export to Word</button>
<button onclick="autoNumberObservations()" type="button">
                Update Summary
            </button>
<button onclick="saveTemplateMeta()" type="button">
                Save as Template
            </button>
<button onclick="loadTemplateMeta()" type="button">
                Load Template
            </button>
<button onclick="saveFinalDraft()" type="button">Save Final Draft</button>
<button onclick="sendToManagement()" type="button">Send to Management</button>
</div>
</div>
<!-- Mandatory summary at top -->
<div class="glass-card" id="printSummary">
<h3>Observation Summary (Index)</h3>
<table class="summary-table">
<thead>
<tr>
<th>Observation No.</th>
<th>Observation</th>
<th>Risk Category</th>
<th>Recommendation (Preview)</th>
</tr>
</thead>
<tbody id="printSummaryBody"></tbody>
</table>
</div>
<!-- OBSERVATIONS by Area -->
<div id="obsContainer">
<!-- 3.1 INTERNAL CONTROLS AND FINANCIAL MANAGEMENT -->
<section class="area-section" data-area="ICFM" id="area-ICFM">
<h3 class="area-heading">INTERNAL CONTROLS AND FINANCIAL MANAGEMENT</h3>
<hr class="observation-divider"/>
<div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Minutes Register for Management Meetings is not properly maintained and no follow-up action taken</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Non Financial">
<option value="Financial">Financial</option>
<option selected="selected" value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="Medium">
<option value="High">High</option>
<option selected="selected" value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Management meetings are conducted periodically to review academics, operations and finance. A minutes register is maintained, however the entries are inconsistent and action points are not systematically tracked.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Minutes of meetings are not recorded in a complete and standard format. Decisions, responsibilities and timelines are either missing or not followed up, resulting in no clear closure of previous meeting action points.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Maintain a formal Minutes Register / digital tracker for every management meeting. Record agenda, decisions, action points, responsible person and target date. At the start of each meeting, review the previous action tracker and document closures and pending items.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Weak governance and accountability. Important decisions may not be implemented on time, recurring issues remain unresolved, and the school may be unable to demonstrate effective oversight to management / Idarah when required.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Principal">
<option disabled="" value="">Select Responsible Person</option>
<option selected="selected" value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Petty cash balance not tallied with physical Cash</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="Medium">
<option value="High">High</option>
<option selected="selected" value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Petty cash is used for day-to-day minor expenses and is recorded through vouchers and a petty cash register. Cash is handled by staff on an imprest / replenishment basis.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Physical cash on hand is not being tallied with the petty cash book balance at regular intervals. Cash count evidence (count sheet / sign-off) is not maintained.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Introduce periodic cash counts (weekly and surprise checks). Reconcile physical cash with the register, retain cash count sheets with signatures, and ensure vouchers are sequential, approved and supported. Fix an imprest limit and replenish only after verification.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Higher risk of cash leakage, incorrect recording of expenses and misstatement of cash balance. Lack of evidence may also weaken audit assurance.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Accountant">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Multiple Books of Accounts Leading to Complex Financial Management.</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="Medium">
<option value="High">High</option>
<option selected="selected" value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Accounts are currently maintained across multiple registers / spreadsheets for different activities and entities. Reporting is prepared by combining information from more than one record set.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Maintaining multiple books of accounts leads to duplication, inconsistent balances, higher manual effort and delays in finalisation. The risk of mismatch between records increases as transaction volume grows.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Move to a unified accounting system with a standard chart of accounts and cost centres (School / Society / Madrasa / Construction). Maintain single source of truth with controlled access. Close books monthly with a checklist and reconciliation.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Complex financial management, inconsistent reporting, and potential compliance/audit issues due to inaccurate consolidation and delayed reviews.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Accountant">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Donation Received from Dawat E Hadiyah not shown in Budget.</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="Medium">
<option value="High">High</option>
<option selected="selected" value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Annual budgets are prepared for income and expenditure, and periodic monitoring is expected to compare actuals against budgeted figures. Donations are received during the year for specific purposes.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Donations received from Dawat-e-Hadiyah are not reflected in the budget / revised budget and are not presented as a separate income line for monitoring and utilisation.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Include donation receipts as a separate budget head and prepare a revised budget / supplementary note when material donations are received. Track utilisation against intended purpose and report variances to the management committee.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Budgeting and planning remain incomplete, reported variances may be misleading, and there is a risk of weak transparency over donor funds utilisation.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Accountant">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Long outstanding advances given to employees</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="Medium">
<option value="High">High</option>
<option selected="selected" value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Advances are provided to employees for travel, purchases or other official requirements and are expected to be settled against bills or recovered within a reasonable period.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Employee advances are outstanding for long periods without settlement or recovery. An ageing review and follow-up mechanism is not consistently applied.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Maintain an employee advance register with issue date, purpose, supporting documents, settlement due date and ageing. Set a standard settlement timeline (e.g., 30 days) and recover overdue balances through salary adjustment after due approvals.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Risk of misuse and non-recovery of funds, inaccurate expense recognition, and increased working capital blockage.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Accountant">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option selected="selected" value="Admin Head">Admin Head</option>
<option value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Bank Statement not reconciled</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="High">
<option selected="selected" value="High">High</option>
<option value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Bank transactions are routed through one or more bank accounts. Statements are received regularly and are required to be reconciled to the cash/bank ledger balances.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Bank reconciliation statements are not prepared on a timely basis and old reconciling items remain unresolved. Differences between bank statement and books are not adequately investigated.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Prepare bank reconciliation monthly within 7 days of month-end. Investigate and clear pending items, including unpresented cheques and unrecorded charges. Obtain management review and sign-off on the BRS.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Risk of undetected errors or irregular transactions, incorrect bank balances in books, and weaker financial control environment.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Accountant">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">No Records for Qardan Hasana Given but same is reflected in books</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="High">
<option selected="selected" value="High">High</option>
<option value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Qardan Hasana is extended as a support mechanism and is recorded in the books. Proper approvals and repayment monitoring are required to ensure recoverability and transparency.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Although Qardan Hasana balances are reflected in the books, supporting documentation and a proper register are not maintained (applications, approvals, acknowledgements and repayment tracking).</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Maintain a Qardan Hasana register capturing recipient details, approval reference, amount, date, purpose, repayment terms and recoveries. Obtain written acknowledgements and periodically review recoverability. Keep all supporting documents filed.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Risk of non-recovery, disputes over terms, and inability to demonstrate governance over such assistance during internal review or statutory scrutiny.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Accountant">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Mismatch between internal balances of School, Society, Madrasa &amp; Construction account</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="High">
<option selected="selected" value="High">High</option>
<option value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Transactions occur between School, Society, Madrasa and Construction accounts, resulting in inter-unit receivables/payables which need periodic reconciliation.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">Inter-unit balances are not reconciled periodically, leading to mismatches between the internal balances of School, Society, Madrasa and Construction accounts.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Prepare an inter-unit reconciliation statement monthly and obtain confirmations between units. Pass necessary journal entries to align balances and ensure inter-unit transactions are supported by proper documentation.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Misstatement of internal receivables/payables, unreliable entity-wise reporting, and delays in finalisation of accounts.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Accountant">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Dormant bank account not closed or recovered</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select" value="Financial">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown" value="Low">
<option value="High">High</option>
<option value="Medium">Medium</option>
<option selected="selected" value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained.">Over time, multiple bank accounts may be opened for operational needs. Dormant accounts should be reviewed periodically and closed if not required.</textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked.">A dormant bank account remains open without business requirement. Necessary closure / recovery action has not been taken and the account is not actively monitored.</textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting.">Review all bank accounts annually. Close dormant accounts through proper resolution and documentation, transfer any balances to the main account, and ensure signatories/KYC are updated where accounts are retained.</textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities.">Risk of unauthorised use, unnecessary bank charges, and weakened control due to unused accounts remaining open.</textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="" value="Management Committee">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div><hr class="observation-divider"/><div class="observation-card glass-card">
<div class="obs-header">
<div class="obs-title-block">
<div class="obs-title-row">
<div class="obs-title-box">
<textarea class="obs-title-input" rows="1">Audit report states Books are maintained on cash basis but in actual it is maintained on Mercantile Basis</textarea>
</div>
</div>
</div>
<div class="obs-meta-row"><div class="obs-number">
                            Observation No.: <span></span>
</div><div class="obs-meta-tags">
<div class="meta-inline">
<div class="meta-pill">
<span class="tag-label">Area:</span>
<select class="area-select"></select>
</div>
<div class="meta-pill">
<span class="tag-label">Type:</span>
<select class="obs-type-select">
<option selected="selected" value="Financial">Financial</option>
<option value="Non Financial">Non Financial</option>
</select>
</div>
<div class="meta-pill">
<span class="tag-label">Risk:</span>
<select class="risk-dropdown">
<option selected="selected" value="High">High</option>
<option value="Medium">Medium</option>
<option value="Low">Low</option>
</select>
</div>
<div class="meta-pill fin-impact-pill" style="display:none;">
<span class="tag-label">Impact (₹):</span>
<input class="fin-impact-input" min="0" step="1" type="number"/>
</div>
</div>
</div><div class="obs-right-group">
<label class="na-toggle">
<input class="na-checkbox" type="checkbox"/>
                                Not Applicable
                            </label>
<button class="collapse-toggle" type="button">Collapse</button>
</div></div>
</div>
<div class="obs-body">
<div class="section-grid">
<div class="field-block">
<div class="field-label">Background</div>
<div class="field-help">
                                Briefly describe the current process / practice followed at the school for this area.
                            </div>
<textarea placeholder="Suggested: Management meetings are held monthly to discuss academic, operational, and financial matters, but no formal minutes or action trackers are maintained."></textarea>
</div>
<div class="field-block">
<div class="field-label">Observation</div>
<div class="field-help">
                                Highlight the specific issue identified during the review.
                            </div>
<textarea placeholder="Suggested: No Minutes Register is maintained; decisions and action points are not documented, and follow-up is not tracked."></textarea>
</div>
<div class="field-block">
<div class="field-label">Recommendation</div>
<div class="field-help">
                                Recommended corrective action as suggested by auditors for process improvement.
                            </div>
<textarea class="recommendation-text" placeholder="Suggested: Introduce a formal Minutes Register (physical or digital) capturing decisions, responsibilities, and timelines. Review progress in each subsequent meeting."></textarea>
</div>
<div class="field-block">
<div class="field-label">Implication</div>
<div class="field-help">
                                Potential qualitative / quantitative impact over operations, finances, or compliance.
                            </div>
<textarea placeholder="Suggested: Risk of decisions not being implemented, lack of accountability, and inability to demonstrate governance to Idarah or statutory authorities."></textarea>
</div>
<div class="field-block">
<div class="field-label">Management Response</div>
<div class="field-help">
                                Structured response from management, including Action Plan.
                            </div>
<div class="sub-field-label">Action Plan</div>
<textarea class="action-plan" placeholder="Detail the exact steps management will take to address the observation."></textarea>
<div class="footer-note">
                                Suggested structure: Specific Action Plan aligned to the observation.
                            </div>
</div>
<div class="section-grid-two">
<div class="field-block narrow-block">
<div class="field-label">Timelines (Tracker)</div>
<div class="field-help">
                                    Due date for implementation of corrective action.
                                </div>
<div class="field-note">
                                    Target Date cannot be earlier than the Audit Date.
                                </div>
<div class="small-columns">
<div class="small-col">
<span class="field-value">Target Date:</span><br/>
<input class="timeline-target" required="" type="date"/>
</div>
<div class="small-col">
<span class="field-value">Status (mandatory):</span><br/>
<select class="status-select" required="">
<option selected="selected" value="Open">Open</option>
<option value="In-Progress">In-Progress</option>
<option value="Closed">Closed</option>
</select>
</div>
</div>
</div>
<div class="field-block">
<div class="field-label">Responsibility</div>
<div class="field-help">
                                    Responsibility assigned for implementation of corrective action (mandatory).
                                </div>
<select class="resp-select" required="">
<option disabled="" value="">Select Responsible Person</option>
<option value="Principal">Principal</option>
<option value="Admin Head">Admin Head</option>
<option selected="selected" value="Accountant">Accountant</option>
<option value="Management Committee">Management Committee</option>
<option value="Other">Other</option>
</select>
</div>
</div>
</div>
<div class="obs-separator"></div>
<div class="footer-note">
</div>
</div>
</div>
<hr class="page-separator"/>
</section>
<!-- 3.2 REVENUE & INCOME RECOGNITION -->
<section class="area-section" data-area="REV" id="area-REV">
<h3 class="area-heading">REVENUE &amp; INCOME RECOGNITION</h3>
</section>
<!-- 3.3 EXPENSES & COST MANAGEMENT -->
<section class="area-section" data-area="EXP" id="area-EXP">
<h3 class="area-heading">EXPENSES &amp; COST MANAGEMENT</h3>
</section>
<!-- 3.4 FIXED ASSETS -->
<section class="area-section" data-area="FA" id="area-FA">
<h3 class="area-heading">FIXED ASSETS</h3>
</section>
<!-- 3.5 LEGAL AND STATUTORY COMPLIANCE -->
<section class="area-section" data-area="LEGAL" id="area-LEGAL">
<h3 class="area-heading">LEGAL AND STATUTORY COMPLIANCE</h3>
</section>
<!-- 3.6 Other Observations -->
<section class="area-section" data-area="OTHER" id="area-OTHER">
<h3 class="area-heading">Other Observations</h3>
</section>
</div>
<!-- Dashboard -->
<div class="dashboard glass-card">
<div class="dashboard-intro">
            Internal Review Dashboard – consolidated analytics for Management overview.
        </div>
<div class="dashboard-header-row">
<div class="dashboard-title">Dashboard Summary</div>
<div class="dashboard-controls">
<span>View:</span>
<select id="dashboardStatusFilter">
<option selected="" value="All">All Statuses</option>
<option value="Open">Open Only</option>
<option value="In-Progress">In-Progress Only</option>
<option value="Closed">Closed Only</option>
</select>
<button class="dash-refresh" onclick="recalcSummary()" type="button">Refresh Dashboard</button>
</div>
</div>
<!-- KPIs -->
<div class="kpi-row">
<div class="kpi-card">
<div class="kpi-label">Observations</div>
<h3 class="kpi-line" id="kpiObsLine1">Total Observations: 0</h3>
<h3 class="kpi-line" id="kpiObsLine2">High: 0 | Medium: 0 | Low: 0</h3>
</div>
<div class="kpi-card">
<div class="kpi-label">Status</div>
<h3 class="kpi-line" id="kpiStatusLine1">Total Status Filled: 0</h3>
<h3 class="kpi-line" id="kpiStatusLine2">
<span class="status-icon status-open-icon"></span>Open:
                    <span id="stKpiOpen">0</span>
                     | 
                    <span class="status-icon status-inprogress-icon"></span>In-Progress:
                    <span id="stKpiInProg">0</span>
                     | 
                    <span class="status-icon status-closed-icon"></span>Closed:
                    <span id="stKpiClosed">0</span>
</h3>
</div>
<div class="kpi-card">
<div class="kpi-label">Financial Observations</div>
<div class="kpi-value" id="kpiFinCount">0</div>
<div class="kpi-subtext">
                    With Impact Filled: <span id="kpiFinImpactFilled">0</span>
</div>
<div class="kpi-subtext">
                    Est. Impact (₹): <span id="kpiFinImpactTotal">₹ 0</span>
</div>
</div>
</div>
<!-- Charts row -->
<div class="dashboard-grid charts-row">
<div class="dashboard-block">
<div class="matrix-card">
<h4>By Observation Type</h4>
<div class="chart-container">
<canvas height="160" id="pieType" width="160"></canvas>
<div class="chart-legend">
<div class="legend-item">
<span class="legend-color" style="background:#1d4ed8;"></span>
                                Financial: <span id="countFinancial">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#22c55e;"></span>
                                Non Financial: <span id="countNonFinancial">0</span>
</div>
</div>
</div>
</div>
</div>
<div class="dashboard-block">
<div class="matrix-card">
<h4>By Risk Level</h4>
<div class="chart-container">
<canvas height="160" id="pieRisk" width="160"></canvas>
<div class="chart-legend">
<div class="legend-item">
<span class="legend-color" style="background:#dc2626;"></span>
                                High: <span id="countHigh">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#facc15;"></span>
                                Medium: <span id="countMedium">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#16a34a;"></span>
                                Low: <span id="countLow">0</span>
</div>
</div>
</div>
</div>
</div>
<div class="dashboard-block">
<div class="matrix-card">
<h4>By Status</h4>
<div class="chart-container">
<canvas height="160" id="pieStatus" width="160"></canvas>
<div class="chart-legend">
<div class="legend-item">
<span class="legend-color" style="background:#0ea5e9;"></span>
                                Open: <span id="countStatusOpen">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#a855f7;"></span>
                                In-Progress: <span id="countStatusInProg">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#22c55e;"></span>
                                Closed: <span id="countStatusClosed">0</span>
</div>
</div>
</div>
</div>
</div>
<div class="dashboard-block">
<div class="matrix-card">
<h4>By Responsibility</h4>
<div class="chart-container">
<canvas height="160" id="pieResp" width="160"></canvas>
<div class="chart-legend">
<div class="legend-item">
<span class="legend-color" style="background:#f97316;"></span>
                                Principal: <span id="countRespPrincipal">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#6366f1;"></span>
                                Admin Head: <span id="countRespAdminHead">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#14b8a6;"></span>
                                Accountant: <span id="countRespAccountant">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#ec4899;"></span>
                                Mgmt Committee: <span id="countRespMgmtCommittee">0</span>
</div>
<div class="legend-item">
<span class="legend-color" style="background:#84cc16;"></span>
                                Other: <span id="countRespOther">0</span>
</div>
</div>
</div>
</div>
</div>
</div>
<!-- Matrices -->
<div class="dashboard-grid" style="margin-top:10px;">
<div class="dashboard-block">
<div class="matrix-card">
<h4>Risk × Type Matrix</h4>
<table class="summary-table">
<thead>
<tr>
<th></th>
<th>High</th>
<th>Medium</th>
<th>Low</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>Financial</td>
<td id="mxFinHigh">0</td>
<td id="mxFinMed">0</td>
<td id="mxFinLow">0</td>
<td id="mxFinTotal"><b>0</b></td>
</tr>
<tr>
<td>Non Financial</td>
<td id="mxNonHigh">0</td>
<td id="mxNonMed">0</td>
<td id="mxNonLow">0</td>
<td id="mxNonTotal"><b>0</b></td>
</tr>
<tr>
<td><b>Grand Total</b></td>
<td id="mxTotalHigh"><b>0</b></td>
<td id="mxTotalMed"><b>0</b></td>
<td id="mxTotalLow"><b>0</b></td>
<td id="mxGrandTotal"><b>0</b></td>
</tr>
</tbody>
</table>
<div class="legend-note">
<strong>Matrix Legend:</strong>
<span class="legend-swatch" style="background:#fee2e2;"></span> High Risk
                         | 
                        <span class="legend-swatch" style="background:#fef9c3;"></span> Medium Risk
                         | 
                        <span class="legend-swatch" style="background:#dcfce7;"></span> Low Risk
                    </div>
</div>
</div>
<div class="dashboard-block">
<div class="matrix-card">
<h4>Status × Risk Matrix</h4>
<table class="summary-table">
<thead>
<tr>
<th>Status</th>
<th>High</th>
<th>Medium</th>
<th>Low</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>Open</td>
<td id="stOpenHigh">0</td>
<td id="stOpenMed">0</td>
<td id="stOpenLow">0</td>
<td id="stOpenTotal"><b>0</b></td>
</tr>
<tr>
<td>In-Progress</td>
<td id="stInProgHigh">0</td>
<td id="stInProgMed">0</td>
<td id="stInProgLow">0</td>
<td id="stInProgTotal"><b>0</b></td>
</tr>
<tr>
<td>Closed</td>
<td id="stClosedHigh">0</td>
<td id="stClosedMed">0</td>
<td id="stClosedLow">0</td>
<td id="stClosedTotal"><b>0</b></td>
</tr>
<tr>
<td><b>Grand Total</b></td>
<td id="stTotalHigh"><b>0</b></td>
<td id="stTotalMed"><b>0</b></td>
<td id="stTotalLow"><b>0</b></td>
<td id="stGrandTotal"><b>0</b></td>
</tr>
</tbody>
</table>
</div>
</div>
<div class="dashboard-block">
<div class="matrix-card">
<h4>Responsibility × Risk Matrix</h4>
<table class="summary-table">
<thead>
<tr>
<th>Responsibility</th>
<th>High</th>
<th>Medium</th>
<th>Low</th>
<th>Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>Principal</td>
<td id="respRskPrincipalHigh">0</td>
<td id="respRskPrincipalMed">0</td>
<td id="respRskPrincipalLow">0</td>
<td id="respRskPrincipalTotal"><b>0</b></td>
</tr>
<tr>
<td>Admin Head</td>
<td id="respRskAdminHigh">0</td>
<td id="respRskAdminMed">0</td>
<td id="respRskAdminLow">0</td>
<td id="respRskAdminTotal"><b>0</b></td>
</tr>
<tr>
<td>Accountant</td>
<td id="respRskAccountantHigh">0</td>
<td id="respRskAccountantMed">0</td>
<td id="respRskAccountantLow">0</td>
<td id="respRskAccountantTotal"><b>0</b></td>
</tr>
<tr>
<td>Management Committee</td>
<td id="respRskMgmtHigh">0</td>
<td id="respRskMgmtMed">0</td>
<td id="respRskMgmtLow">0</td>
<td id="respRskMgmtTotal"><b>0</b></td>
</tr>
<tr>
<td>Other</td>
<td id="respRskOtherHigh">0</td>
<td id="respRskOtherMed">0</td>
<td id="respRskOtherLow">0</td>
<td id="respRskOtherTotal"><b>0</b></td>
</tr>
<tr>
<td><b>Grand Total</b></td>
<td id="respTotalHigh"><b>0</b></td>
<td id="respTotalMed"><b>0</b></td>
<td id="respTotalLow"><b>0</b></td>
<td id="respGrandTotal"><b>0</b></td>
</tr>
</tbody>
</table>
</div>
</div>
</div><div class="dashboard-grid pair-row" style="margin-top:10px;"><div class="dashboard-block">
<div class="matrix-card">
<h4>Action Plan Documentation &amp; Key Alerts</h4>
<table class="summary-table">
<tbody>
<tr><th>Action Plan defined</th><td id="apComplete">0</td></tr>
<tr><th>Missing Action Plan</th><td id="apMissingAP">0</td></tr>
<tr><th>Missing Timeline</th><td id="apMissingTL">0</td></tr>
<tr><th>Missing Responsibility</th><td id="apMissingOnus">0</td></tr>
</tbody>
</table>
<div class="chip-row" style="margin-top:6px;">
<span class="chip chip-ok" id="chipRisk">Risk load: OK</span>
<span class="chip chip-ok" id="chipOverdue">Overdue: None</span>
<span class="chip chip-ok" id="chipQuality">Documentation: Healthy</span>
</div>
</div>
</div><div class="dashboard-block">
<div class="matrix-card">
<h4>Due Date Bands</h4>
<table class="summary-table">
<thead>
<tr>
<th>Band</th>
<th>Count</th>
</tr>
</thead>
<tbody>
<tr><td>Due in 0–7 days</td><td id="band0_7">0</td></tr>
<tr><td>Due in 8–15 days</td><td id="band8_15">0</td></tr>
<tr><td>Due in 16–30 days</td><td id="band16_30">0</td></tr>
<tr><td>Due in 30+ days / No date</td><td id="band30p">0</td></tr>
</tbody>
</table>
<div class="legend-note">
                        Counts include Open / In-Progress observations shown in the dashboard (Closed excluded).
                        Overdue items are counted in the 0–7 band for urgency.
                    </div>
</div>
</div></div><div class="dashboard-grid pair-row" style="margin-top:10px;"><div class="dashboard-block">
<div class="matrix-card">
<h4>Area-wise Risk Matrix</h4>
<table class="summary-table area-risk-matrix">
<thead>
<tr>
<th>Area</th>
<th>High</th>
<th>Medium</th>
<th>Low</th>
<th class="total-col">Total</th>
</tr>
</thead>
<tbody>
<tr>
<td>INTERNAL CONTROLS AND FINANCIAL MANAGEMENT</td>
<td id="areaICFMHigh">0</td>
<td id="areaICFMMed">0</td>
<td id="areaICFMLow">0</td>
<td class="total-col" id="areaICFMTotal">0</td>
</tr>
<tr>
<td>REVENUE &amp; INCOME RECOGNITION</td>
<td id="areaREVHigh">0</td>
<td id="areaREVMed">0</td>
<td id="areaREVLow">0</td>
<td class="total-col" id="areaREVTotal">0</td>
</tr>
<tr>
<td>EXPENSES &amp; COST MANAGEMENT</td>
<td id="areaEXPHigh">0</td>
<td id="areaEXPMed">0</td>
<td id="areaEXPLow">0</td>
<td class="total-col" id="areaEXPTotal">0</td>
</tr>
<tr>
<td>FIXED ASSETS</td>
<td id="areaFAHigh">0</td>
<td id="areaFAMed">0</td>
<td id="areaFALow">0</td>
<td class="total-col" id="areaFATotal">0</td>
</tr>
<tr>
<td>LEGAL AND STATUTORY COMPLIANCE</td>
<td id="areaLEGALHigh">0</td>
<td id="areaLEGALMed">0</td>
<td id="areaLEGALLow">0</td>
<td class="total-col" id="areaLEGALTotal">0</td>
</tr>
<tr>
<td>Other Observations</td>
<td id="areaOTHERHigh">0</td>
<td id="areaOTHERMed">0</td>
<td id="areaOTHERLow">0</td>
<td class="total-col" id="areaOTHERTotal">0</td>
</tr>
<tr class="grand-total-row">
<td><b>Grand Total</b></td>
<td id="areaTotalHigh"><b>0</b></td>
<td id="areaTotalMed"><b>0</b></td>
<td id="areaTotalLow"><b>0</b></td>
<td class="total-col" id="areaGrandTotal"><b>0</b></td>
</tr>
</tbody>
</table>
<div class="legend-note">
                        Colours indicate risk intensity for each area (heatmap): darker shades generally indicate higher observation counts.
                        <span class="legend-swatch" style="background:#fee2e2;"></span> High
                        <span class="legend-swatch" style="background:#fef9c3; margin-left:6px;"></span> Medium
                        <span class="legend-swatch" style="background:#dcfce7; margin-left:6px;"></span> Low
                    </div>
</div>
</div><div class="dashboard-block">
<div class="matrix-card">
<h4>Section-wise Ageing Tracker</h4>
<table class="summary-table section-ageing-tracker">
<thead>
<tr>
<th>Section</th>
<th>Open</th>
<th>In-Progress</th>
<th>Closed</th>
<th>Overdue</th>
<th>Total</th></tr>
</thead>
<tbody id="sectionAgeingBody"></tbody>
</table>
<div class="legend-note">
                        Shows, for each section, the count of open / in-progress observations and the maximum days overdue based on Target Date.
                    </div>
</div>
</div></div>
<!-- Action plan & Area-wise -->
<!-- Section-wise Ageing Tracker -->
<!-- Timeline Band View -->
<!-- Timelines -->
<div class="dashboard-grid" style="margin-top:10px;">
<div class="dashboard-block">
<div class="matrix-card">
<h4>Observation Timelines (Target Date vs Responsibility)</h4>
<table class="summary-table timeline-table">
<thead>
<tr>
<th>Obs No.</th>
<th>Target Date</th>
<th>Status</th>
<th>Overdue (Days)</th>
<th>No. of days to go</th>
<th>Timeline</th>
</tr>
</thead>
<tbody id="obsTimelineBody"></tbody>
</table>
<div class="legend-note"><div style="margin-bottom:6px;">
<b>Instruction:</b> Click any <b>Timeline</b> bar to jump directly to the related Observation card in the Observation Deck.
<br/>
<b>Insight:</b> Use this quick jump to review the full context and action plan before updating status / responsibility.
</div>
<strong>Timeline Legend:</strong>
                        ⚠ = Overdue (Target date has passed).<br/>
                        Bar length represents how far the target date lies between the earliest and latest targets
                        (longer bar = relatively later deadline within the review window).<br/>
<span class="legend-swatch" style="background:#dc2626;"></span> High Risk
                        <span class="legend-swatch" style="background:#facc15; margin-left:6px;"></span> Medium Risk
                        <span class="legend-swatch" style="background:#16a34a; margin-left:6px;"></span> Low Risk
                    </div>
</div>
</div>
</div>
<div class="audit-info">
<div>Version: <strong>v2.0 – Internal Review Dashboard | Copyright &amp; Created by. CA Ahmed Ali</strong></div>
<div>Last Updated: <span id="dashLastUpdate">-</span></div>
</div>
</div>
</div>
<script>
/* --- Area configuration --- */
const AREA_CONFIG = [
    { id: "ICFM",  label: "INTERNAL CONTROLS AND FINANCIAL MANAGEMENT"},
    { id: "REV",   label: "REVENUE & INCOME RECOGNITION"},
    { id: "EXP",   label: "EXPENSES & COST MANAGEMENT"},
    { id: "FA",    label: "FIXED ASSETS"},
    { id: "LEGAL", label: "LEGAL AND STATUTORY COMPLIANCE"},
    { id: "OTHER", label: "Other Observations"}
];

const AREA_BG_CONFIG = {
    ICFM: "radial-gradient(circle at top left, #e0f2fe 0, #f4f5f7 35%, #e5e7eb 100%)",
    REV:  "linear-gradient(135deg, #fff7ed 0, #fffbeb 40%, #fef3c7 100%)",
    EXP:  "linear-gradient(135deg, #f0f9ff 0, #e0f2fe 40%, #e5f3ff 100%)",
    FA:   "linear-gradient(135deg, #ecfdf5 0, #dcfce7 40%, #bbf7d0 100%)",
    LEGAL:"linear-gradient(135deg, #fef2f2 0, #fee2e2 40%, #ffe4e6 100%)",
    OTHER:"linear-gradient(135deg, #f9fafb 0, #e5e7eb 40%, #e5e7eb 100%)"};

function applyAreaBackground(areaId) {
    const bg = AREA_BG_CONFIG[areaId] || AREA_BG_CONFIG.ICFM;
    document.body.style.background = bg;
    applySummaryBackground(areaId);
}

function applySummaryBackground(areaId){
    const el = document.getElementById("printSummary");
    if(!el) return;
    const MAP = {
        ICFM: "linear-gradient(135deg, rgba(224,242,254,0.95), rgba(244,245,247,0.95))",
        REV:  "linear-gradient(135deg, rgba(255,247,237,0.95), rgba(254,243,199,0.92))",
        EXP:  "linear-gradient(135deg, rgba(240,249,255,0.95), rgba(224,242,254,0.95))",
        FA:   "linear-gradient(135deg, rgba(236,253,245,0.95), rgba(220,252,231,0.95))",
        LEGAL:"linear-gradient(135deg, rgba(254,242,242,0.95), rgba(254,226,226,0.92))",
        OTHER:"linear-gradient(135deg, rgba(249,250,251,0.95), rgba(229,231,235,0.95))"};
    el.style.background = MAP[areaId] || MAP.ICFM;
}


const TEMPLATE_VALID_UNTIL = new Date("2026-03-31T23:59:59");
let currentAreaKey = "ICFM";
applySummaryBackground(currentAreaKey);


function getAreaLabelById(id) {
    const found = AREA_CONFIG.find(a => a.id === id);
    return found ? found.label : "Other Observations";
}

function getCurrentDateISO() {
    const now = new Date();
    const y = now.getFullYear();
    const m = String(now.getMonth() + 1).padStart(2, "0");
    const d = String(now.getDate()).padStart(2, "0");
    return y + "-"+ m + "-"+ d;
}

function formatIndianNumber(num) {
    const n = Number(num);
    if (isNaN(n)) return num;
    const parts = n.toString().split(".");
    let integer = parts[0];
    const lastThree = integer.slice(-3);
    const other = integer.slice(0, -3);
    if (other !== "") {
        integer = other.replace(/\B(?=(\d{2})+(?!\d))/g, ",") + ","+ lastThree;
    }
    return parts.length > 1 ? integer + "."+ parts[1] : integer;
}

function numberToIndianWords(num) {
    if (!num || isNaN(num)) return "Rupees Zero Only";

    const a = [
        "", "One", "Two", "Three", "Four", "Five", "Six", "Seven", "Eight", "Nine",
        "Ten", "Eleven", "Twelve", "Thirteen", "Fourteen", "Fifteen",
        "Sixteen", "Seventeen", "Eighteen", "Nineteen"];
    const b = [
        "", "", "Twenty", "Thirty", "Forty", "Fifty",
        "Sixty", "Seventy", "Eighty", "Ninety"];

    function inWords(n) {
        if (n < 20) return a[n];
        if (n < 100) return b[Math.floor(n / 10)] + (n % 10 ? ""+ a[n % 10] : "");
        if (n < 1000)
            return a[Math.floor(n / 100)] + "Hundred"+ (n % 100 ? "and "+ inWords(n % 100) : "");
        if (n < 100000)
            return inWords(Math.floor(n / 1000)) + "Thousand"+ (n % 1000 ? ""+ inWords(n % 1000) : "");
        if (n < 10000000)
            return inWords(Math.floor(n / 100000)) + "Lakh"+ (n % 100000 ? ""+ inWords(n % 100000) : "");
        return inWords(Math.floor(n / 10000000)) + "Crore"+ (n % 10000000 ? ""+ inWords(n % 10000000) : "");
    }

    return "Rupees "+ inWords(num) + "Only";
}

function checkTemplateExpiry() {
    const now = new Date();
    const warnEl = document.getElementById("expiryWarning");
    if (!warnEl) return;

    if (now > TEMPLATE_VALID_UNTIL) {
        warnEl.textContent =
            "⚠ IMPORTANT: This Internal Review format is past its approved validity date. "+
            "Reports generated after "+
            formatDDMMMYY(TEMPLATE_VALID_UNTIL) +
            "may not comply with updated Idarah / management guidelines and should be reviewed carefully before use.";
        warnEl.style.color = "#b91c1c";
    } else {
        warnEl.textContent = "";
    }
}

/* textareas */
function autoResizeTextarea(el) {
    el.style.height = "auto";
    el.style.height = el.scrollHeight + "px";
}
function initTextareas(card) {
    card.querySelectorAll("textarea").forEach(t => {
        autoResizeTextarea(t);
        t.addEventListener("input", () => {
            autoResizeTextarea(t);
            // keep print mirror synced
            const mirror = t.nextElementSibling;
            if (mirror && mirror.classList && mirror.classList.contains("print-textarea-mirror")) {
                mirror.textContent = t.value || "";
            }
        });
    });
}

/* --- Print-safe textarea mirrors (avoid scrollbars / clipped content in PDF) --- */
function ensureTextareaMirrors() {
    document.querySelectorAll("textarea").forEach(t => {
        // create once
        let mirror = t.nextElementSibling;
        if (!mirror || !mirror.classList || !mirror.classList.contains("print-textarea-mirror")) {
            mirror = document.createElement("div");
            mirror.className = "print-textarea-mirror";
            t.insertAdjacentElement("afterend", mirror);
        }
        mirror.textContent = t.value || "";
    });
}
function expandAllTextareasForPrint() {
    document.querySelectorAll("textarea").forEach(t => {
        t.style.height = "auto";
        t.style.height = t.scrollHeight + "px";
        t.style.overflow = "visible";
        t.style.whiteSpace = "normal";
    });
}

/* Risk colour */
function applyRiskColour(card, riskValue) {
    const header = card.querySelector(".obs-header");
    const dropdown = card.querySelector(".risk-dropdown");
    if (!header || !dropdown) return;

    if (riskValue === "High") {
        header.style.background = "linear-gradient(135deg,#b91c1c,#7f1d1d)";
        dropdown.style.backgroundColor = "#fee2e2";
        dropdown.style.color = "#b91c1c";
    } else if (riskValue === "Medium") {
        header.style.background = "linear-gradient(135deg,#facc15,#854d0e)";
        dropdown.style.backgroundColor = "#fef9c3";
        dropdown.style.color = "#854d0e";
    } else if (riskValue === "Low") {
        header.style.background = "linear-gradient(135deg,#16a34a,#166534)";
        dropdown.style.backgroundColor = "#dcfce7";
        dropdown.style.color = "#166534";
    } else {
        header.style.background = "linear-gradient(135deg,rgba(12,74,110,0.92),rgba(15,23,42,0.96))";
        dropdown.style.backgroundColor = "#ffffff";
        dropdown.style.color = "#0c4a6e";
    }

    // Risk accent class for left bar
    card.classList.remove("risk-high","risk-medium","risk-low");
    if (riskValue === "High") card.classList.add("risk-high");
    else if (riskValue === "Medium") card.classList.add("risk-medium");
    else if (riskValue === "Low") card.classList.add("risk-low");

}

function initRisk(card) {
    const dropdown = card.querySelector(".risk-dropdown");
    if (!dropdown) return;
    applyRiskColour(card, dropdown.value);
    dropdown.addEventListener("change", function () {
        applyRiskColour(card, dropdown.value);
        recalcSummary();
    });
}

/* Financial impact pill */
function updateFinancialImpactVisibility(card) {
    const typeSel = card.querySelector(".obs-type-select");
    const pill = card.querySelector(".fin-impact-pill");
    if (!typeSel || !pill) return;
    if (typeSel.value === "Financial") {
        pill.style.display = "inline-flex";
    } else {
        pill.style.display = "none";
        const inp = pill.querySelector(".fin-impact-input");
        if (inp) inp.value = "";
    }
}
function initType(card) {
    const sel = card.querySelector(".obs-type-select");
    if (!sel) return;
    updateFinancialImpactVisibility(card);
    sel.addEventListener("change", function () {
        updateFinancialImpactVisibility(card);
        recalcSummary();
    });
}

/* Pie chart */
function drawPieChart(canvasId, data, colors) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext("2d");
    const total = data.reduce((a, b) => a + b, 0);
    const w = canvas.width;
    const h = canvas.height;
    const cx = w / 2;
    const cy = h / 2;
    const r = Math.min(w, h) / 2 - 5;
    ctx.clearRect(0, 0, w, h);
    if (total === 0) {
        ctx.fillStyle = "#e5e7eb";
        ctx.beginPath();
        ctx.arc(cx, cy, r, 0, Math.PI * 2);
        ctx.fill();
        return;
    }
    let start = -Math.PI / 2;
    data.forEach((val, i) => {
        if (val <= 0) return;
        const angle = (val / total) * Math.PI * 2;
        ctx.beginPath();
        ctx.moveTo(cx, cy);
        ctx.arc(cx, cy, r, start, start + angle);
        ctx.closePath();
        ctx.fillStyle = colors[i];
        ctx.fill();
        start += angle;
    });
}

/* Dashboard filter inclusion */
function shouldIncludeInDashboard(card) {
    const na = card.querySelector(".na-checkbox");
    if (na && na.checked) return false;

    const statusFilterEl = document.getElementById("dashboardStatusFilter");
    const statusFilter = statusFilterEl ? statusFilterEl.value : "All";
    if (statusFilter === "All") return true;

    const statusSel = card.querySelector(".status-select");
    const statusVal = statusSel ? statusSel.value : "";
    return statusVal === statusFilter;
}

/* Matrix cell colours */
function applyMatrixColorStyles() {
    // Heatmap-style colouring for dashboard matrices (keeps traditional risk colours, adds intensity by volume)
    function parseCellNumber(el) {
        if (!el) return 0;
        const t = (el.textContent || "").replace(/[^0-9\-]/g, "");
        const n = parseInt(t, 10);
        return isNaN(n) ? 0 : n;
    }
    function setTint(ids, rgb, textRgb) {
        const els = ids.map(id => document.getElementById(id)).filter(Boolean);
        const vals = els.map(parseCellNumber);
        const max = Math.max(0, ...vals);

        els.forEach((el, i) => {
            const v = vals[i];
            // If max = 0, keep a very light tint so the matrix still looks structured
            const alpha = max === 0 ? 0.10 : Math.min(0.65, 0.12 + (v / max) * 0.50);
            el.style.backgroundColor = `rgba(${rgb[0]},${rgb[1]},${rgb[2]},${alpha})`;
            el.style.color = `rgb(${textRgb[0]},${textRgb[1]},${textRgb[2]})`;
        });
    }

    // Base colours
    const RGB_HIGH_BG = [185, 28, 28];
    const RGB_MED_BG  = [133, 77, 14];
    const RGB_LOW_BG  = [22, 163, 74];

    const RGB_HIGH_TX = [185, 28, 28];
    const RGB_MED_TX  = [133, 77, 14];
    const RGB_LOW_TX  = [22, 101, 52];

    // Risk × Type Matrix
    setTint(["mxFinHigh","mxNonHigh","mxTotalHigh"], RGB_HIGH_BG, RGB_HIGH_TX);
    setTint(["mxFinMed","mxNonMed","mxTotalMed"],  RGB_MED_BG,  RGB_MED_TX);
    setTint(["mxFinLow","mxNonLow","mxTotalLow"],  RGB_LOW_BG,  RGB_LOW_TX);

    // Status × Risk Matrix
    setTint(["stOpenHigh","stInProgHigh","stClosedHigh","stTotalHigh"], RGB_HIGH_BG, RGB_HIGH_TX);
    setTint(["stOpenMed","stInProgMed","stClosedMed","stTotalMed"],    RGB_MED_BG,  RGB_MED_TX);
    setTint(["stOpenLow","stInProgLow","stClosedLow","stTotalLow"],    RGB_LOW_BG,  RGB_LOW_TX);

    // Responsibility × Risk Matrix
    setTint(["respRskPrincipalHigh","respRskAdminHigh","respRskAccountantHigh","respRskMgmtHigh","respRskOtherHigh","respTotalHigh"], RGB_HIGH_BG, RGB_HIGH_TX);
    setTint(["respRskPrincipalMed","respRskAdminMed","respRskAccountantMed","respRskMgmtMed","respRskOtherMed","respTotalMed"],      RGB_MED_BG,  RGB_MED_TX);
    setTint(["respRskPrincipalLow","respRskAdminLow","respRskAccountantLow","respRskMgmtLow","respRskOtherLow","respTotalLow"],      RGB_LOW_BG,  RGB_LOW_TX);

    // Area-wise Risk Matrix
    setTint(["areaICFMHigh","areaREVHigh","areaEXPHigh","areaFAHigh","areaLEGALHigh","areaOTHERHigh","areaTotalHigh"], RGB_HIGH_BG, RGB_HIGH_TX);
    setTint(["areaICFMMed","areaREVMed","areaEXPMed","areaFAMed","areaLEGALMed","areaOTHERMed","areaTotalMed"],       RGB_MED_BG,  RGB_MED_TX);
    setTint(["areaICFMLow","areaREVLow","areaEXPLow","areaFALow","areaLEGALLow","areaOTHERLow","areaTotalLow"],       RGB_LOW_BG,  RGB_LOW_TX);

    // Totals cells: keep clean & bold
    const totalIds = ["mxFinTotal","mxNonTotal","mxGrandTotal","stOpenTotal","stInProgTotal","stClosedTotal","stGrandTotal",
                      "respRskPrincipalTotal","respRskAdminTotal","respRskAccountantTotal","respRskMgmtTotal","respRskOtherTotal","respGrandTotal",
                      "areaICFMTotal","areaREVTotal","areaEXPTotal","areaFATotal","areaLEGALTotal","areaOTHERTotal","areaGrandTotal"];
    totalIds.forEach(id => {
        const el = document.getElementById(id);
        if (el) {
            el.style.fontWeight = "700";
        }
    });
}

/* Main dashboard recompute */
function recalcSummary() {
    const now = new Date();

    let total = 0;
    let open = 0, inProg = 0, closed = 0, statusFilled = 0;
    let financial = 0, nonFinancial = 0;
    let respPrincipal = 0, respAdmin = 0, respAccountant = 0, respMgmt = 0, respOther = 0;
    let high = 0, medium = 0, low = 0;

    let fHigh = 0, fMed = 0, fLow = 0;
    let nfHigh = 0, nfMed = 0, nfLow = 0;

    let finCount = 0, finImpactFilled = 0, finImpactTotal = 0;

    let apComplete = 0, apMissingAP = 0, apMissingTL = 0, apMissingOnus = 0;

    const areaRisk = {};
    AREA_CONFIG.forEach(a => {
        areaRisk[a.id] = { High: 0, Medium: 0, Low: 0 };
    });

    let stOpenHigh = 0, stOpenMed = 0, stOpenLow = 0;
    let stInProgHigh = 0, stInProgMed = 0, stInProgLow = 0;
    let stClosedHigh = 0, stClosedMed = 0, stClosedLow = 0;

    let respRskPrincipalHigh = 0, respRskPrincipalMed = 0, respRskPrincipalLow = 0;
    let respRskAdminHigh = 0, respRskAdminMed = 0, respRskAdminLow = 0;
    let respRskAccountantHigh = 0, respRskAccountantMed = 0, respRskAccountantLow = 0;
    let respRskMgmtHigh = 0, respRskMgmtMed = 0, respRskMgmtLow = 0;
    let respRskOtherHigh = 0, respRskOtherMed = 0, respRskOtherLow = 0;

    const timelineEntries = [];

    // Timeline band buckets (Open / In-Progress only)
    let band0_7 = 0, band8_15 = 0, band16_30 = 0, band30p = 0;

    document.querySelectorAll(".observation-card").forEach((card, cardIdx) => {
        if (!shouldIncludeInDashboard(card)) return;

        const typeSel = card.querySelector(".obs-type-select");
        const riskSel = card.querySelector(".risk-dropdown");
        const respSel = card.querySelector(".resp-select");
        const statusSel = card.querySelector(".status-select");
        const dtInput = card.querySelector(".timeline-target");
        const finImpactInp = card.querySelector(".fin-impact-input");
        const apTextarea = card.querySelector(".action-plan");
        const numSpan = card.querySelector(".obs-number span");

        const typeVal = typeSel ? typeSel.value : "";
        const riskVal = riskSel ? riskSel.value : "";
        const respVal = respSel ? respSel.value : "";
        const statusVal = statusSel ? statusSel.value : "";
        const obsNum = numSpan ? numSpan.textContent.trim() : "";
        // Anchor id for dashboard hyperlinks (stable per Observation No.)
        let anchorId = (card.id && card.id.trim() !== "") ? card.id : "";
        if (!anchorId) {
            if (obsNum && obsNum !== "N/A") {
                anchorId = "obs-" + obsNum.replace(/[^0-9]+/g, "-").replace(/(^-+|-+$)/g, "");
            } else {
                anchorId = "obs-card-" + (cardIdx + 1);
            }
            card.id = anchorId;
        }


        let areaId = "OTHER";
        const section = card.closest(".area-section");
        if (section && section.dataset.area) {
            areaId = section.dataset.area;
            if (!areaRisk[areaId]) areaId = "OTHER";
        }

        if (respVal === "Principal") respPrincipal++;
        else if (respVal === "Admin Head") respAdmin++;
        else if (respVal === "Accountant") respAccountant++;
        else if (respVal === "Management Committee") respMgmt++;
        else if (respVal === "Other") respOther++;

        total++;

        if (statusVal) statusFilled++;
        if (statusVal === "Open") open++;
        else if (statusVal === "In-Progress") inProg++;
        else if (statusVal === "Closed") closed++;

        const isFin = (typeVal === "Financial");
        if (isFin) financial++;
        else if (typeVal === "Non Financial") nonFinancial++;

        if (riskVal === "High") high++;
        else if (riskVal === "Medium") medium++;
        else if (riskVal === "Low") low++;

        if (isFin) {
            if (riskVal === "High") fHigh++;
            else if (riskVal === "Medium") fMed++;
            else if (riskVal === "Low") fLow++;
        } else if (typeVal === "Non Financial") {
            if (riskVal === "High") nfHigh++;
            else if (riskVal === "Medium") nfMed++;
            else if (riskVal === "Low") nfLow++;
        }

        function bumpStatusRisk(status, risk) {
            if (risk !== "High"&& risk !== "Medium"&& risk !== "Low") return;
            if (status === "Open") {
                if (risk === "High") stOpenHigh++;
                else if (risk === "Medium") stOpenMed++;
                else if (risk === "Low") stOpenLow++;
            } else if (status === "In-Progress") {
                if (risk === "High") stInProgHigh++;
                else if (risk === "Medium") stInProgMed++;
                else if (risk === "Low") stInProgLow++;
            } else if (status === "Closed") {
                if (risk === "High") stClosedHigh++;
                else if (risk === "Medium") stClosedMed++;
                else if (risk === "Low") stClosedLow++;
            }
        }
        bumpStatusRisk(statusVal, riskVal);

        function bumpRespRisk(resp, risk) {
            if (resp === "Principal") {
                if (risk === "High") respRskPrincipalHigh++;
                else if (risk === "Medium") respRskPrincipalMed++;
                else if (risk === "Low") respRskPrincipalLow++;
            } else if (resp === "Admin Head") {
                if (risk === "High") respRskAdminHigh++;
                else if (risk === "Medium") respRskAdminMed++;
                else if (risk === "Low") respRskAdminLow++;
            } else if (resp === "Accountant") {
                if (risk === "High") respRskAccountantHigh++;
                else if (risk === "Medium") respRskAccountantMed++;
                else if (risk === "Low") respRskAccountantLow++;
            } else if (resp === "Management Committee") {
                if (risk === "High") respRskMgmtHigh++;
                else if (risk === "Medium") respRskMgmtMed++;
                else if (risk === "Low") respRskMgmtLow++;
            } else if (resp === "Other") {
                if (risk === "High") respRskOtherHigh++;
                else if (risk === "Medium") respRskOtherMed++;
                else if (risk === "Low") respRskOtherLow++;
            }
        }
        if (respVal && riskVal) bumpRespRisk(respVal, riskVal);

        let dt = null;
        let diffDays = null;
        if (dtInput && dtInput.value) {
            const tmpDt = new Date(dtInput.value + "T00:00:00");
            if (!isNaN(tmpDt.getTime())) {
                dt = tmpDt;
                const diffMs = dt - now;
                diffDays = diffMs / (1000 * 60 * 60 * 24);
            }
        }


        // Due date band view (treat missing status as Open; missing date -> 30+ bucket; overdue -> 0–7 bucket)
        const effStatus = statusVal ? statusVal : "Open";
        if (effStatus !== "Closed") {
            if (diffDays === null || diffDays === undefined) {
                band30p++;
            } else if (diffDays <= 7) {
                band0_7++;
            } else if (diffDays <= 15) {
                band8_15++;
            } else if (diffDays <= 30) {
                band16_30++;
            } else {
                band30p++;
            }
        }

        timelineEntries.push({
            obsNum,
            dt,
            resp: respVal,
            risk: riskVal,
            diffDays,
            status: statusVal,
            anchorId
        });

        if (isFin) {
            finCount++;
            if (finImpactInp && finImpactInp.value.trim() !== "") {
                let val = Number(finImpactInp.value);
                if (!isNaN(val)) {
                    val = Math.round(val);
                    finImpactInp.value = val;
                    finImpactFilled++;
                    finImpactTotal += val;
                }
            }
        }

        const hasAP = apTextarea && apTextarea.value.trim() !== "";
        const hasMgmtTL = dtInput && dtInput.value;
        const hasOnus = respSel && respSel.value;

        if (hasAP && hasMgmtTL && hasOnus) {
            apComplete++;
        } else {
            if (!hasAP) apMissingAP++;
            if (!hasMgmtTL) apMissingTL++;
            if (!hasOnus) apMissingOnus++;
        }

        if (!areaRisk[areaId]) areaId = "OTHER";
        if (riskVal === "High"|| riskVal === "Medium"|| riskVal === "Low") {
            areaRisk[areaId][riskVal]++;
        }
    });

    /* KPIs text */
    const obsLine1 = document.getElementById("kpiObsLine1");
    const obsLine2 = document.getElementById("kpiObsLine2");
    if (obsLine1) obsLine1.textContent = "Total Observations: "+ total;
    if (obsLine2) obsLine2.textContent =
        "High: "+ high + "| Medium: "+ medium + "| Low: "+ low;

    const stLine1 = document.getElementById("kpiStatusLine1");
    if (stLine1) stLine1.textContent = "Total Status Filled: "+ statusFilled;

    const stKpiOpen   = document.getElementById("stKpiOpen");
    const stKpiInProg = document.getElementById("stKpiInProg");
    const stKpiClosed = document.getElementById("stKpiClosed");
    if (stKpiOpen)   stKpiOpen.textContent   = open;
    if (stKpiInProg) stKpiInProg.textContent = inProg;
    if (stKpiClosed) stKpiClosed.textContent = closed;

    const stLegendOpen   = document.getElementById("countStatusOpen");
    const stLegendInProg = document.getElementById("countStatusInProg");
    const stLegendClosed = document.getElementById("countStatusClosed");
    if (stLegendOpen)   stLegendOpen.textContent   = open;
    if (stLegendInProg) stLegendInProg.textContent = inProg;
    if (stLegendClosed) stLegendClosed.textContent = closed;

    /* Financial impact */
    const finFormatted = finImpactTotal ? "₹ "+ formatIndianNumber(finImpactTotal) : "₹ 0";
    document.getElementById("kpiFinCount").textContent = finCount;
    document.getElementById("kpiFinImpactFilled").textContent = finImpactFilled;
    document.getElementById("kpiFinImpactTotal").innerHTML =
        finFormatted +
        "<br><span style='font-size:10pt; font-weight:normal; text-decoration:none;'>"+
        numberToIndianWords(finImpactTotal || 0) +
        "</span>";

    /* basic counts */
    document.getElementById("countFinancial").textContent = financial;
    document.getElementById("countNonFinancial").textContent = nonFinancial;
    document.getElementById("countHigh").textContent = high;
    document.getElementById("countMedium").textContent = medium;
    document.getElementById("countLow").textContent = low;

    document.getElementById("mxFinHigh").textContent = fHigh;
    document.getElementById("mxFinMed").textContent = fMed;
    document.getElementById("mxFinLow").textContent = fLow;
    document.getElementById("mxFinTotal").innerHTML = "<b>"+ (fHigh + fMed + fLow) + "</b>";

    document.getElementById("mxNonHigh").textContent = nfHigh;
    document.getElementById("mxNonMed").textContent = nfMed;
    document.getElementById("mxNonLow").textContent = nfLow;
    document.getElementById("mxNonTotal").innerHTML = "<b>"+ (nfHigh + nfMed + nfLow) + "</b>";

    const setText = (id, val, bold) => {
        const el = document.getElementById(id);
        if (el) el.innerHTML = bold ? "<b>"+ val + "</b>": val;
    };

    let stOpenTotal = stOpenHigh + stOpenMed + stOpenLow;
    let stInProgTotal = stInProgHigh + stInProgMed + stInProgLow;
    let stClosedTotal = stClosedHigh + stClosedMed + stClosedLow;

    setText("stOpenHigh", stOpenHigh);
    setText("stOpenMed", stOpenMed);
    setText("stOpenLow", stOpenLow);
    setText("stOpenTotal", stOpenTotal, true);

    setText("stInProgHigh", stInProgHigh);
    setText("stInProgMed", stInProgMed);
    setText("stInProgLow", stInProgLow);
    setText("stInProgTotal", stInProgTotal, true);

    setText("stClosedHigh", stClosedHigh);
    setText("stClosedMed", stClosedMed);
    setText("stClosedLow", stClosedLow);
    setText("stClosedTotal", stClosedTotal, true);

    
function jumpToObservationCard(cardId){
    const el = document.getElementById(cardId);
    if (!el) return;

    const toolbar = document.querySelector(".toolbar");
    const offset = toolbar ? (toolbar.getBoundingClientRect().height + 12) : 60;

    const y = el.getBoundingClientRect().top + window.pageYOffset - offset;
    window.scrollTo({ top: y, behavior: "smooth" });
}

function setAreaRow(prefix, data) {
        const high = data.High || 0;
        const med  = data.Medium || 0;
        const low  = data.Low || 0;
        const totalArea = high + med + low;
        setText(prefix + "High", high);
        setText(prefix + "Med", med);
        setText(prefix + "Low", low);
        setText(prefix + "Total", totalArea);
    }

    setAreaRow("areaICFM",  areaRisk["ICFM"]);
    setAreaRow("areaREV",   areaRisk["REV"]);
    setAreaRow("areaEXP",   areaRisk["EXP"]);
    setAreaRow("areaFA",    areaRisk["FA"]);
    setAreaRow("areaLEGAL", areaRisk["LEGAL"]);
    setAreaRow("areaOTHER", areaRisk["OTHER"]);

    setText("respRskPrincipalHigh", respRskPrincipalHigh);
    setText("respRskPrincipalMed",  respRskPrincipalMed);
    setText("respRskPrincipalLow",  respRskPrincipalLow);
    setText("respRskPrincipalTotal",
            respRskPrincipalHigh + respRskPrincipalMed + respRskPrincipalLow, true);

    setText("respRskAdminHigh", respRskAdminHigh);
    setText("respRskAdminMed",  respRskAdminMed);
    setText("respRskAdminLow",  respRskAdminLow);
    setText("respRskAdminTotal",
            respRskAdminHigh + respRskAdminMed + respRskAdminLow, true);

    setText("respRskAccountantHigh", respRskAccountantHigh);
    setText("respRskAccountantMed",  respRskAccountantMed);
    setText("respRskAccountantLow",  respRskAccountantLow);
    setText("respRskAccountantTotal",
            respRskAccountantHigh + respRskAccountantMed + respRskAccountantLow, true);

    setText("respRskMgmtHigh", respRskMgmtHigh);
    setText("respRskMgmtMed",  respRskMgmtMed);
    setText("respRskMgmtLow",  respRskMgmtLow);
    setText("respRskMgmtTotal",
            respRskMgmtHigh + respRskMgmtMed + respRskMgmtLow, true);

    setText("respRskOtherHigh", respRskOtherHigh);
    setText("respRskOtherMed",  respRskOtherMed);
    setText("respRskOtherLow",  respRskOtherLow);
    setText("respRskOtherTotal",
            respRskOtherHigh + respRskOtherMed + respRskOtherLow, true);

    const respLegendPrincipal  = document.getElementById("countRespPrincipal");
    const respLegendAdmin      = document.getElementById("countRespAdminHead");
    const respLegendAccountant = document.getElementById("countRespAccountant");
    const respLegendMgmt       = document.getElementById("countRespMgmtCommittee");
    const respLegendOther      = document.getElementById("countRespOther");

    if (respLegendPrincipal)  respLegendPrincipal.textContent  = respPrincipal;
    if (respLegendAdmin)      respLegendAdmin.textContent      = respAdmin;
    if (respLegendAccountant) respLegendAccountant.textContent = respAccountant;
    if (respLegendMgmt)       respLegendMgmt.textContent       = respMgmt;
    if (respLegendOther)      respLegendOther.textContent      = respOther;

    document.getElementById("apComplete").textContent   = apComplete;
    document.getElementById("apMissingAP").textContent  = apMissingAP;
    document.getElementById("apMissingTL").textContent  = apMissingTL;
    document.getElementById("apMissingOnus").textContent= apMissingOnus;

    drawPieChart("pieType",   [financial, nonFinancial], ["#1d4ed8", "#22c55e"]);
    drawPieChart("pieRisk",   [high, medium, low],       ["#dc2626", "#facc15", "#16a34a"]);
    drawPieChart("pieStatus", [open, inProg, closed],    ["#0ea5e9", "#a855f7", "#22c55e"]);
    drawPieChart("pieResp",
        [respPrincipal, respAdmin, respAccountant, respMgmt, respOther],
        ["#f97316", "#6366f1", "#14b8a6", "#ec4899", "#84cc16"]
    );

    const chipRisk = document.getElementById("chipRisk");
    const chipOverdue = document.getElementById("chipOverdue");
    const chipQuality = document.getElementById("chipQuality");

    chipRisk.className = "chip";
    if (high >= 5) {
        chipRisk.classList.add("chip-bad");
        chipRisk.textContent = "Risk load: Many high-risk (≥5)";
    } else if (high >= 1) {
        chipRisk.classList.add("chip-warn");
        chipRisk.textContent = "Risk load: Some high-risk present";
    } else {
        chipRisk.classList.add("chip-ok");
        chipRisk.textContent = "Risk load: No high-risk";
    }

    let tlOverdue = 0, tlLt7 = 0, tl7to30 = 0, tlGt30 = 0;

    const tbodyTL = document.getElementById("obsTimelineBody");
    if (tbodyTL) {
        tbodyTL.innerHTML = "";

        if (timelineEntries.length) {
            timelineEntries.forEach(entry => {
                if (entry.diffDays == null || isNaN(entry.diffDays)) return;
                if (entry.diffDays < 0) tlOverdue++;
                else if (entry.diffDays < 7) tlLt7++;
                else if (entry.diffDays < 30) tl7to30++;
                else tlGt30++;
            });

            const timelineEntriesLocal = timelineEntries.slice();

            timelineEntriesLocal.sort((a, b) => {
                const nA = parseFloat((a.obsNum || "").replace(/[^\d.]/g, "")) || 0;
                const nB = parseFloat((b.obsNum || "").replace(/[^\d.]/g, "")) || 0;
                return nA - nB;
            });

            let timelineMin = null;
            let timelineMax = null;
            const datedEntries = timelineEntriesLocal.filter(e => e.dt && !isNaN(e.dt.getTime()));
            datedEntries.forEach(entry => {
                if (!timelineMin || entry.dt < timelineMin) timelineMin = entry.dt;
                if (!timelineMax || entry.dt > timelineMax) timelineMax = entry.dt;
            });
            const spanMs = timelineMax && timelineMin ? (timelineMax - timelineMin || 1) : 1;

            /* MANDATORY timeline rows for all observations (even without date) */
            timelineEntriesLocal.forEach(entry => {
                const tr = document.createElement("tr");

                const tdObs = document.createElement("td");
                tdObs.textContent = entry.obsNum || "-";

                const tdDate = document.createElement("td");
                tdDate.textContent =
                    entry.dt && !isNaN(entry.dt.getTime())
                        ? formatDDMMMYY(entry.dt)
                        : "-";

                const tdStatus = document.createElement("td");
                tdStatus.textContent = entry.status || "-";

                let overdueDays = "-";
                let daysToGo = "-";
                if (entry.diffDays != null && !isNaN(entry.diffDays)) {
                    const rounded = Math.round(entry.diffDays);
                    if (rounded < 0) {
                        overdueDays = "⚠ "+ Math.abs(rounded);
                        daysToGo = "-";
                    } else if (rounded > 0) {
                        overdueDays = "-";
                        daysToGo = rounded;
                    } else {
                        overdueDays = "-";
                        daysToGo = "0";
                    }
                }

                const tdOverdue = document.createElement("td");
                tdOverdue.textContent = overdueDays;
                const tdDaysToGo = document.createElement("td");
                tdDaysToGo.textContent = daysToGo;

                const tdBar = document.createElement("td");
                const outer = document.createElement("div");
                outer.className = "timeline-bar-outer";
                const inner = document.createElement("div");
                inner.className = "timeline-bar-inner";

                let widthPct = 20;
                if (entry.dt && !isNaN(entry.dt.getTime()) && timelineMax && timelineMin) {
                    widthPct = Math.max(20, Math.min(100, ((entry.dt - timelineMin) / spanMs) * 100));
                }

                let barColor = "#9ca3af";
                if (entry.risk === "High") barColor = "#dc2626";
                else if (entry.risk === "Medium") barColor = "#facc15";
                else if (entry.risk === "Low") barColor = "#16a34a";

                inner.style.width = widthPct + "%";
                inner.style.background = barColor;

                const label = document.createElement("div");
                label.className = "timeline-bar-label";
                label.textContent = entry.resp || (entry.dt ? "": "No date set");

                outer.appendChild(inner);
                outer.appendChild(label);

                const anchor = entry.anchorId;
                const link = document.createElement("a");
                link.className = "timeline-link";
                link.href = anchor ? ("#" + anchor) : "#";
                link.addEventListener("click", function(e){
                    if (!anchor) return;
                    e.preventDefault();
                    jumpToObservationCard(anchor);
                });
                link.appendChild(outer);
                tdBar.appendChild(link);

                tr.appendChild(tdObs);
                tr.appendChild(tdDate);
                tr.appendChild(tdStatus);
                tr.appendChild(tdOverdue);
                tr.appendChild(tdDaysToGo);
                tr.appendChild(tdBar);

                tbodyTL.appendChild(tr);
            });
        }
    }

    chipOverdue.className = "chip";
    if (tlOverdue > 0) {
        chipOverdue.classList.add("chip-bad");
        chipOverdue.textContent = "Overdue: "+ tlOverdue + "past due";
    } else if (tlLt7 > 0 || tl7to30 > 0 || tlGt30 > 0) {
        chipOverdue.classList.add("chip-warn");
        chipOverdue.textContent = "Upcoming deadlines in next 90 days";
    } else {
        chipOverdue.classList.add("chip-ok");
        chipOverdue.textContent = "Overdue: None";
    }

    chipQuality.className = "chip";
    let qualityText = "Documentation: -";
    if (total > 0) {
        const ratio = apComplete / total;
        if (ratio >= 0.8) {
            chipQuality.classList.add("chip-ok");
            qualityText = "Documentation: Strong (≥80% fully documented)";
        } else if (ratio >= 0.5) {
            chipQuality.classList.add("chip-warn");
            qualityText = "Documentation: Moderate (50–80% complete)";
        } else {
            chipQuality.classList.add("chip-bad");
            qualityText = "Documentation: Weak (<50% fully documented)";
        }
    } else {
        chipQuality.classList.add("chip-ok");
        qualityText = "Documentation: No applicable observations";
    }
    chipQuality.textContent = qualityText;

    const dashUpdate = document.getElementById("dashLastUpdate");
    if (dashUpdate) dashUpdate.textContent = formatDDMMMYY(new Date());

    
    // --- Matrix totals (row/column) ---
    const mxTh = document.getElementById('mxTotalHigh');
    if (mxTh) {
        document.getElementById('mxTotalHigh').textContent = (fHigh + nfHigh);
        document.getElementById('mxTotalMed').textContent  = (fMed + nfMed);
        document.getElementById('mxTotalLow').textContent  = (fLow + nfLow);
        document.getElementById('mxGrandTotal').innerHTML  = '<b>' + ((fHigh+nfHigh)+(fMed+nfMed)+(fLow+nfLow)) + '</b>';
    }

    const stTh = document.getElementById('stTotalHigh');
    if (stTh) {
        document.getElementById('stTotalHigh').textContent = (stOpenHigh + stInProgHigh + stClosedHigh);
        document.getElementById('stTotalMed').textContent  = (stOpenMed  + stInProgMed  + stClosedMed);
        document.getElementById('stTotalLow').textContent  = (stOpenLow  + stInProgLow  + stClosedLow);
        document.getElementById('stGrandTotal').innerHTML  = '<b>' + (
            (stOpenHigh+stOpenMed+stOpenLow) +
            (stInProgHigh+stInProgMed+stInProgLow) +
            (stClosedHigh+stClosedMed+stClosedLow)
        ) + '</b>';
    }

    const rpTh = document.getElementById('respTotalHigh');
    if (rpTh) {
        const rHigh = respRskPrincipalHigh+respRskAdminHigh+respRskAccountantHigh+respRskMgmtHigh+respRskOtherHigh;
        const rMed  = respRskPrincipalMed+respRskAdminMed+respRskAccountantMed+respRskMgmtMed+respRskOtherMed;
        const rLow  = respRskPrincipalLow+respRskAdminLow+respRskAccountantLow+respRskMgmtLow+respRskOtherLow;
        document.getElementById('respTotalHigh').textContent = rHigh;
        document.getElementById('respTotalMed').textContent  = rMed;
        document.getElementById('respTotalLow').textContent  = rLow;
        document.getElementById('respGrandTotal').innerHTML  = '<b>' + (rHigh+rMed+rLow) + '</b>';
    }

    const arTh = document.getElementById('areaTotalHigh');
    if (arTh) {
        let aHigh=0,aMed=0,aLow=0;
        AREA_CONFIG.forEach(a=>{
          aHigh += (areaRisk[a.id]?.High||0);
          aMed  += (areaRisk[a.id]?.Medium||0);
          aLow  += (areaRisk[a.id]?.Low||0);
        });
        document.getElementById('areaTotalHigh').textContent = aHigh;
        document.getElementById('areaTotalMed').textContent  = aMed;
        document.getElementById('areaTotalLow').textContent  = aLow;
        document.getElementById('areaGrandTotal').innerHTML  = '<b>' + (aHigh+aMed+aLow) + '</b>';
    }


    // Update timeline band counts
    const b0 = document.getElementById("band0_7");
    const b1 = document.getElementById("band8_15");
    const b2 = document.getElementById("band16_30");
    const b3 = document.getElementById("band30p");
    if (b0) b0.textContent = band0_7;
    if (b1) b1.textContent = band8_15;
    if (b2) b2.textContent = band16_30;
    if (b3) b3.textContent = band30p;

    applyMatrixColorStyles();
}

/* Observation counter */
function updateObsCounter() {
    const counterEl = document.getElementById("obsCounter");
    if (!counterEl) return;
    let count = 0;
    document.querySelectorAll(".observation-card").forEach(card => {
        const na = card.querySelector(".na-checkbox");
        if (na && na.checked) return;
        count++;
    });
    counterEl.textContent = formatIndianNumber(count);
}

function autoNumberObservations() {
    const sections = document.querySelectorAll(".area-section");
    let areaIndex = 0;

    sections.forEach(section => {
        areaIndex++;
        const cards = section.querySelectorAll(".observation-card");
        let obsIndex = 0;

        cards.forEach((card, cardPos) => {
            const numSpan = card.querySelector(".obs-number span");
            const na = card.querySelector(".na-checkbox");

            if (na && na.checked) {
                if (numSpan) numSpan.textContent = "N/A";
                card.classList.add("na-card");
                // Keep a unique anchor even for N/A cards (not included in dashboard)
                card.id = "obs-na-" + areaIndex + "-" + (cardPos + 1);
            } else {
                card.classList.remove("na-card");
                obsIndex++;
                const obsNo = areaIndex + "." + obsIndex;
                if (numSpan) numSpan.textContent = obsNo;
                // Stable anchor id used by dashboard timeline hyperlinks
                card.id = "obs-" + areaIndex + "-" + obsIndex;
            }
            syncCardAreaSelect(card);
        });
    });

    updateObsCounter();
    recalcSummary();
    buildPrintSummary();
    refreshObservationJump();
}

function updateTargetDayLabel(dtInput) {
    if (!dtInput) return;
    const wrapper = dtInput.closest(".small-col") || dtInput.parentElement;
    if (!wrapper) return;

    let label = wrapper.querySelector(".target-day-label");
    if (!label) {
        label = document.createElement("div");
        label.className = "target-day-label";
        label.style.fontSize = "10px";
        label.style.color = "#374151";
        label.style.marginTop = "2px";
        wrapper.appendChild(label);
    }

    if (!dtInput.value) {
        label.textContent = "";
        return;
    }

    const d = new Date(dtInput.value + "T00:00:00");
    if (isNaN(d.getTime())) {
        label.textContent = "";
        return;
    }

    const days = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
    label.textContent = days[d.getDay()];
}

/* Date validation for Timelines */
function initDates(card) {
    const dt = card.querySelector(".timeline-target");
    if (!dt) return;

    const auditInput = document.getElementById("metaAuditDate");
    const todayISO = getCurrentDateISO();
    let minDate = todayISO;

    if (auditInput && auditInput.value) {
        const auditDateISO = auditInput.value;
        minDate = auditDateISO > todayISO ? auditDateISO : todayISO;
    }

    dt.min = minDate;
    if (dt.value && dt.value < minDate) {
        dt.value = minDate;
    }
    updateTargetDayLabel(dt);

    dt.addEventListener("change", function () {
        if (dt.min && dt.value && dt.value < dt.min) {
            dt.value = dt.min;
        }
        updateTargetDayLabel(dt);
    });
}

/* Not Applicable */
function initApplicability(card) {
    const cb = card.querySelector(".na-checkbox");
    if (!cb) return;
    cb.addEventListener("change", function () {
        autoNumberObservations();
    });
}

/* Collapse per card */
function initCollapse(card) {
    const btn = card.querySelector(".collapse-toggle");
    if (!btn) return;
    btn.addEventListener("click", function (e) {
        e.stopPropagation();
        const collapsed = card.classList.toggle("collapsed");
        btn.textContent = collapsed ? "Expand": "Collapse";
        updateGlobalCollapseButtonState();
    });
}

function setAllCardsCollapsed(collapsed) {
    document.querySelectorAll(".observation-card").forEach(card => {
        card.classList.toggle("collapsed", collapsed);
        const btn = card.querySelector(".collapse-toggle");
        if (btn) btn.textContent = collapsed ? "Expand": "Collapse";
    });
}

function areAllCardsCollapsed() {
    const cards = document.querySelectorAll(".observation-card");
    if (cards.length === 0) return false;
    return Array.from(cards).every(card => card.classList.contains("collapsed"));
}

function updateGlobalCollapseButtonState() {
    const globalBtn = document.getElementById("btnToggleAllObs");
    if (!globalBtn) return;
    const allCollapsed = areAllCardsCollapsed();
    globalBtn.textContent = allCollapsed ? "Expand all": "Collapse all";
}

/* Location sync to toolbar */
function syncLocationToCards() {
    const locInput = document.getElementById("metaLocation");
    const locRaw = locInput && locInput.value ? locInput.value : "–";
    const loc = toProperCase(locRaw);
    const tl = document.getElementById("toolbarLocation");
    if (tl) tl.textContent = loc;
}

/* Default selects */
function resetSelects(card) {
    const status = card.querySelector(".status-select");
    if (status) status.value = "Open";
    const resp = card.querySelector(".resp-select");
    if (resp) resp.value = "";
    const typeSel = card.querySelector(".obs-type-select");
    if (typeSel) typeSel.value = "Non Financial";
}

/* Header date format */
function formatHeaderDate(dateStr) {
    // Universal date format: DD/MMM/YY
    if (!dateStr) return "Date of Audit";
    const parts = dateStr.split("-");
    if (parts.length !== 3) return dateStr;
    const [y, m, d] = parts;
    const dt = new Date(`${y}-${m}-${d}T00:00:00`);
    if (isNaN(dt.getTime())) return dateStr;
    return formatDDMMMYY(dt);
}

function formatDDMMMYY(dt) {
    if (!dt || isNaN(dt.getTime())) return "-";
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const DD  = String(dt.getDate()).padStart(2, "0");
    const MMM = months[dt.getMonth()];
    const YY  = String(dt.getFullYear()).slice(-2);
    return `${DD}/${MMM}/${YY}`;
}



function formatHeaderDateMMMDDYY(dateStr) {
    // Report header date format: MMM DD, YY (keep other dates unchanged)
    if (!dateStr) return "Date";
    const parts = dateStr.split("-");
    if (parts.length !== 3) return dateStr;
    const [y, m, d] = parts;
    const dt = new Date(`${y}-${m}-${d}T00:00:00`);
    if (isNaN(dt.getTime())) return dateStr;
    return formatMMMDDYY(dt);
}

function formatMMMDDYY(dt) {
    const months = ["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"];
    const m = months[dt.getMonth()];
    const d = String(dt.getDate()).padStart(2, "0");
    const y = String(dt.getFullYear()).slice(-2);
    return `${m} ${d}, ${y}`;
}


/* Proper case (School / Location in header) */
function toProperCase(str) {
    if (!str) return "";
    return str
        .split(/\s+/)
        .filter(Boolean)
        .map(w => {
            const clean = w.trim();
            if (!clean) return "";
            // Preserve short/all-caps tokens (e.g., MSB, NGO, GST, ID) and single letters.
            const lettersOnly = clean.replace(/[^A-Za-z]/g, "");
            if ((lettersOnly.length <= 3 && lettersOnly === lettersOnly.toUpperCase()) || lettersOnly.length === 1) {
                return clean;
            }
            // Preserve mixed tokens with digits (e.g., FY2025)
            if (/[0-9]/.test(clean)) return clean;
            return clean.charAt(0).toUpperCase() + clean.slice(1).toLowerCase();
        })
        .join(" ");
}
/* Header text */
function syncHeader() {
    const schoolRaw = document.getElementById("metaSchoolName")?.value || "School";
    const school = toProperCase(schoolRaw);
    const locationRaw = document.getElementById("metaLocation")?.value || "Location";
    const location = toProperCase(locationRaw);
    const period = document.getElementById("metaPeriod")?.value || "Period of Review";
    const auditRaw = document.getElementById("metaAuditDate")?.value || "";
    const auditDateDisplay = formatHeaderDate(auditRaw);
    const auditDateHeader = formatHeaderDateMMMDDYY(auditRaw);
    const prepared = document.getElementById("metaPreparedBy")?.value || "Prepared By";
    const header = document.getElementById("reportHeader");
    const auditDisp = document.getElementById("metaAuditDateDisplay");
    if (auditDisp) auditDisp.textContent = auditDateDisplay;
    if (!header) return;
    header.innerHTML = `${school} | ${location} | ${period} | Audit Date: ${auditDateHeader || "-"} | Prepared By: ${prepared}`;
}

/* Area label in card */

/* Area selector in card (dropdown) */
function syncCardAreaSelect(card) {
    const sel = card.querySelector(".area-select");
    if (!sel) return;

    // Populate options once per card
    if (!sel.dataset.ready) {
        sel.innerHTML = AREA_CONFIG
            .map(a => `<option value="${a.id}">${a.label}</option>`)
            .join("");
        sel.dataset.ready = "1";
    }

    const section = card.closest(".area-section");
    let areaId = "OTHER";
    if (section && section.dataset.area) areaId = section.dataset.area;

    sel.value = areaId;
}

/* Move card to another area section when dropdown changes */
function moveCardToArea(card, areaId) {
    const targetSection = document.querySelector(`.area-section[data-area="${areaId}"]`);
    if (!targetSection || !card) return;

    // Move the card AND its page separator (if the separator is the immediate next sibling)
    const next = card.nextElementSibling;
    const sepToMove = (next && next.tagName === "HR"&& next.classList.contains("page-separator")) ? next : null;

    // Append to target section (keeps grouping clean)
    targetSection.appendChild(card);

    if (sepToMove) {
        targetSection.appendChild(sepToMove);
    } else {
        // Ensure consistent spacing in the target section
        const hr = document.createElement("hr");
        hr.className = "page-separator";
        targetSection.appendChild(hr);
    }

    // Re-number and refresh summary/dashboard/jump (autoNumberObservations already calls these)
    autoNumberObservations();
}




/* Robust area regrouping (delegated handler) */
(function () {
    if (window.__areaSelectDelegated) return;
    window.__areaSelectDelegated = true;

    document.addEventListener("change", function (e) {
        const target = e.target;
        if (!target || !target.classList || !target.classList.contains("area-select")) return;
        const card = target.closest(".observation-card");
        if (!card) return;
        moveCardToArea(card, target.value);
    });
})();

/* Init dropdown + event */
function initAreaSelect(card) {
    const sel = card.querySelector(".area-select");
    if (!sel) return;

    syncCardAreaSelect(card);

    // Avoid double-binding if init runs again
    if (sel.dataset.bound) return;
    sel.dataset.bound = "1";

    sel.addEventListener("change", function () {
        moveCardToArea(card, sel.value);
    });
}


/* Print summary builder */
function buildPrintSummary() {
    const tbody = document.getElementById("printSummaryBody");
    if (!tbody) return;
    tbody.innerHTML = "";

    // Collect rows
    const groups = {}; // areaId -> [{num,title,risk,rec}]
    const areaLabel = {}; // areaId -> label

    document.querySelectorAll(".observation-card").forEach(card => {
        const na = card.querySelector(".na-checkbox");
        if (na && na.checked) return;

        const numSpan = card.querySelector(".obs-number span");
        const titleInput = card.querySelector(".obs-title-input");
        const riskSel = card.querySelector(".risk-dropdown");
        const recTextarea = card.querySelector(".recommendation-text");

        const num = numSpan ? numSpan.textContent.trim() : "";
        const title = titleInput ? titleInput.value.trim() : "";
        const risk = riskSel ? riskSel.value : "";
        let rec = recTextarea ? recTextarea.value.trim() : "";
        if (rec.length > 230) rec = rec.slice(0, 227) + "...";

        let areaId = "OTHER";
        let area = "Other Observations";
        const section = card.closest(".area-section");
        if (section && section.dataset.area) {
            areaId = section.dataset.area;
            area = getAreaLabelById(section.dataset.area);
        }

        if (!groups[areaId]) groups[areaId] = [];
        areaLabel[areaId] = area;

        groups[areaId].push({ num, area, title, risk, rec });
    });

    // Render grouped (area order as per AREA_CONFIG)
    const areaOrder = AREA_CONFIG.map(a => a.id);
    // Ensure OTHER is always last
    if (!areaOrder.includes("OTHER")) areaOrder.push("OTHER");

    areaOrder.forEach(areaId => {
        const rows = groups[areaId];
        if (!rows || rows.length === 0) return;

        // Area separator row (visual grouping)
        const areaTr = document.createElement("tr");
        areaTr.className = "summary-area-row";
        areaTr.setAttribute("data-area", areaId);
        const areaTd = document.createElement("td");
        areaTd.colSpan = 4;
        areaTd.textContent = areaLabel[areaId] || getAreaLabelById(areaId) || "Other Observations";
        areaTr.appendChild(areaTd);
        tbody.appendChild(areaTr);

        rows.forEach(r => {
            const tr = document.createElement("tr");
            const cells = [r.num, r.title, r.risk, r.rec];

            cells.forEach((value, idx) => {
                const td = document.createElement("td");
                td.textContent = value;

                // Risk cell formatting
                if (idx === 2) {
                    if (value === "High") {
                        td.style.backgroundColor = "#fee2e2";
                        td.style.color = "#b91c1c";
                        td.style.fontWeight = "700";
                    } else if (value === "Medium") {
                        td.style.backgroundColor = "#fef9c3";
                        td.style.color = "#854d0e";
                        td.style.fontWeight = "700";
                    } else if (value === "Low") {
                        td.style.backgroundColor = "#dcfce7";
                        td.style.color = "#166534";
                        td.style.fontWeight = "700";
                    }
                }

                tr.appendChild(td);
            });

            tbody.appendChild(tr);
        });
    });
}

/* Expand all cards for export */
function expandAllCardsForExport() {
    document.querySelectorAll(".observation-card").forEach(card => {
        card.classList.remove("collapsed");
        const btn = card.querySelector(".collapse-toggle");
        if (btn) btn.textContent = "Collapse";
    });
    updateGlobalCollapseButtonState();
}

function initCard(card) {
    initTextareas(card);
    initRisk(card);
    initApplicability(card);
    initType(card);
    initDates(card);
    initCollapse(card);
    initAreaSelect(card);
    syncCardAreaSelect(card);
}

/* Find current area section from dropdown selection */
function findCurrentAreaSection() {
    let section = document.querySelector(`.area-section[data-area="${currentAreaKey}"]`);
    if (!section) section = document.querySelector(".area-section");
    return section;
}

/* Create and append new card for a given section (used for both auto-fill and toolbar Add) */
function createNewCardInSection(section, templateCard, scrollIntoView = false) {
    if (!section || !templateCard) return null;

    const newCard = templateCard.cloneNode(true);

    newCard.querySelectorAll("textarea").forEach(t => t.value = "");
    resetSelects(newCard);

    const na = newCard.querySelector(".na-checkbox");
    if (na) na.checked = false;
    newCard.classList.remove("na-card");
    newCard.classList.remove("collapsed");

    const collapseBtn = newCard.querySelector(".collapse-toggle");
    if (collapseBtn) collapseBtn.textContent = "Collapse";

    const riskSel = newCard.querySelector(".risk-dropdown");
    if (riskSel) riskSel.value = "Medium";

    const titleInput = newCard.querySelector(".obs-title-input");
    if (titleInput) titleInput.value = "";

    const finImpactInput = newCard.querySelector(".fin-impact-input");
    if (finImpactInput) finImpactInput.value = "";

    const dtInput = newCard.querySelector(".timeline-target");
    if (dtInput) {
        dtInput.value = "";
        updateTargetDayLabel(dtInput);
    }

    const divider = document.createElement("hr");
    divider.className = "observation-divider";
    section.appendChild(divider);

    section.appendChild(newCard);

    const pageSep = document.createElement("hr");
    pageSep.className = "page-separator";
    section.appendChild(pageSep);

    initCard(newCard);
    updateGlobalCollapseButtonState();
    syncLocationToCards();
    autoNumberObservations();

    if (scrollIntoView) {
        newCard.scrollIntoView({ behavior: "smooth", block: "start"});
    }
    return newCard;
}

/* Toolbar button: add observation, with explicit area selection */
function addObservationCard() {
    let defaultArea = currentAreaKey || "ICFM";

    let message = "Select area for this observation:\n";
    AREA_CONFIG.forEach(a => {
        message += a.id + "- "+ a.label + "\n";
    });
    message += "\nLeave blank to use the currently selected section.";

    let areaId = window.prompt(message, defaultArea);
    // If user cancels, do not add a new observation
    if (areaId === null) return;
    // Blank = use currently selected section
    areaId = (areaId || "").trim();
    if (!areaId) areaId = defaultArea;
    let section = null;

    if (areaId) {
        areaId = areaId.trim().toUpperCase();
        const exists = AREA_CONFIG.some(a => a.id === areaId);
        if (exists) {
            currentAreaKey = areaId;

            const sectionCandidate = document.querySelector('.area-section[data-area="' + areaId + '"]');
            if (sectionCandidate) {
                section = sectionCandidate;
            }

            const jump = document.getElementById("areaJump");
            if (jump) {
                jump.value = areaId;
            }

            if (typeof applyAreaBackground === "function") {
                applyAreaBackground(areaId);
            }
        }
    }

    if (!section) {
        section = findCurrentAreaSection();
    }
    if (!section) return;

    const cards = section.querySelectorAll(".observation-card");
    let templateCard;
    if (cards.length > 0) {
        templateCard = cards[cards.length - 1];
    } else {
        templateCard = document.querySelector(".observation-card");
    }
    createNewCardInSection(section, templateCard, true);
}


/* --- Data persistence for exports (critical fix) ---
   When we serialize HTML (Final Draft / Send to Management / Word export),
   the browser does NOT automatically write live form values back into HTML attributes.
   Result: downloaded file opens with defaults.
   This helper synchronizes current values -> DOM attributes/text so exports retain entered data.
*/
function syncFormStateToDomAttributes(root = document) {
    const fields = root.querySelectorAll("input, textarea, select");
    fields.forEach(el => {
        const tag = el.tagName;
        if (tag === "TEXTAREA") {
            // Ensure textarea value is embedded into markup
            el.textContent = el.value || "";
        } else if (tag === "SELECT") {
            // Ensure selected option is embedded into markup
            Array.from(el.options).forEach(opt => {
                if (opt.selected) opt.setAttribute("selected", "selected");
                else opt.removeAttribute("selected");
            });
        } else if (tag === "INPUT") {
            const type = (el.getAttribute("type") || "").toLowerCase();
            if (type === "checkbox"|| type === "radio") {
                if (el.checked) el.setAttribute("checked", "checked");
                else el.removeAttribute("checked");
            } else {
                el.setAttribute("value", el.value || "");
            }
        }
    });
}

/* PDF export */
function exportToPDF() {
    syncFormStateToDomAttributes();
expandAllCardsForExport();
    autoNumberObservations();
    syncHeader();
    buildPrintSummary();
    expandAllTextareasForPrint();
    ensureTextareaMirrors();
    window.print();
}

/* Word export */
function exportToWord() {
    expandAllCardsForExport();
    autoNumberObservations();
    syncHeader();
    buildPrintSummary();
    expandAllTextareasForPrint();
    syncFormStateToDomAttributes();

    function esc(v){
        if (v === null || v === undefined) return "";
        return String(v)
          .replace(/&/g,"&amp;")
          .replace(/</g,"&lt;")
          .replace(/>/g,"&gt;")
          .replace(/"/g,"&quot;");
    }

    const meta = {
        school: document.getElementById("metaSchoolName")?.value || "",
        location: document.getElementById("metaLocation")?.value || "",
        period: document.getElementById("metaPeriod")?.value || "",
        auditDate: document.getElementById("metaAuditDate")?.value || "",
        preparedBy: document.getElementById("metaPreparedBy")?.value || ""};

    let out = "";
    out += `<h1 style="font-family:'Times New Roman', serif; margin:0 0 10px 0;">Internal Review Report – Observation Summary</h1>`;
    out += `
      <table style="width:100%; border-collapse:collapse; font-family: Calibri, Arial, sans-serif; font-size:11pt;"border="1">
        <tr><td style="padding:6px; font-weight:bold; width:20%;">School</td><td style="padding:6px;">${esc(meta.school)}</td></tr>
        <tr><td style="padding:6px; font-weight:bold;">Location</td><td style="padding:6px;">${esc(meta.location)}</td></tr>
        <tr><td style="padding:6px; font-weight:bold;">Period of Review</td><td style="padding:6px;">${esc(meta.period)}</td></tr>
        <tr><td style="padding:6px; font-weight:bold;">Date of Audit</td><td style="padding:6px;">${esc(meta.auditDate)}</td></tr>
        <tr><td style="padding:6px; font-weight:bold;">Prepared By</td><td style="padding:6px;">${esc(meta.preparedBy)}</td></tr>
      </table>
      <hr style="margin:12px 0;">
    `;

    document.querySelectorAll(".area-section").forEach(section=>{
        const areaTitle = section.querySelector(".area-heading")?.textContent?.trim() || "";
        const cards = section.querySelectorAll(".observation-card:not(.na-card)");
        if(cards.length===0) return;

        out += `<h2 style="font-family:'Times New Roman', serif; margin:14px 0 6px 0;">${esc(areaTitle)}</h2>`;

        cards.forEach(card=>{
            const titleEl = card.querySelector(".obs-title-textarea, .obs-title-input");
            const title = titleEl ? (titleEl.value || titleEl.textContent || "").trim() : "";
            const no = card.querySelector(".obs-number span")?.textContent?.trim() || "";
            const risk = card.querySelector(".risk-dropdown")?.value || "";
            const type = card.querySelector(".obs-type-select")?.value || "";
            const impact = card.querySelector(".fin-impact-input")?.value || "";

            const taList = [...card.querySelectorAll(".obs-body textarea")];
            const getTA = (i)=> (taList[i] ? (taList[i].value||"").trim() : "");
            const background = getTA(0);
            const observation = getTA(1);
            const recommendation = (card.querySelector(".recommendation-text")?.value || getTA(2)).trim();
            const implication = getTA(3);
            const actionPlan = (card.querySelector(".action-plan")?.value || getTA(4)).trim();
            const target = card.querySelector(".timeline-target")?.value || "";
            const status = card.querySelector(".status-select")?.value || "Open";
            const responsibility = card.querySelector(".resp-select")?.value || "";
            const reviewer = (card.querySelector(".review-notes")?.value || "").trim();

            out += `
              <table style="width:100%; border-collapse:collapse; font-family: Calibri, Arial, sans-serif; font-size:11pt; margin:8px 0 14px 0;"border="1">
                <tr>
                  <td colspan="2"style="background:#f3f4f6; font-weight:bold; padding:6px;">
                    Observation ${esc(no)}: ${esc(title)}
                  </td>
                </tr>
                <tr>
                  <td style="width:22%; padding:6px; font-weight:bold;">Type / Risk</td>
                  <td style="padding:6px;">${esc(type)} | ${esc(risk)}${impact ? ("| Impact (₹): "+esc(impact)) : ""}</td>
                </tr>
                <tr><td style="padding:6px; font-weight:bold;">Background</td><td style="padding:6px;">${esc(background).replace(/\n/g,"<br>")}</td></tr>
                <tr><td style="padding:6px; font-weight:bold;">Observation</td><td style="padding:6px;">${esc(observation).replace(/\n/g,"<br>")}</td></tr>
                <tr><td style="padding:6px; font-weight:bold;">Recommendation</td><td style="padding:6px;">${esc(recommendation).replace(/\n/g,"<br>")}</td></tr>
                <tr><td style="padding:6px; font-weight:bold;">Implication</td><td style="padding:6px;">${esc(implication).replace(/\n/g,"<br>")}</td></tr>
                <tr><td style="padding:6px; font-weight:bold;">Management Action Plan</td><td style="padding:6px;">${esc(actionPlan).replace(/\n/g,"<br>")}</td></tr>
                <tr>
                  <td style="padding:6px; font-weight:bold;">Timeline / Onus</td>
                  <td style="padding:6px;">Target: ${esc(target)} | Status: ${esc(status)} | Responsibility: ${esc(responsibility)}</td>
                </tr>
                <tr><td style="padding:6px; font-weight:bold;">Reviewer Notes</td><td style="padding:6px;">${esc(reviewer).replace(/\n/g,"<br>")}</td></tr>
              </table>
            `;
        });
    });

    const preHtml = "<html xmlns:o='urn:schemas-microsoft-com:office:office' "+
        "xmlns:w='urn:schemas-microsoft-com:office:word' "+
        "xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Internal Review</title></head><body>";
    const postHtml = "</body></html>";

    const blob = new Blob(['\ufeff', preHtml + out + postHtml], { type: 'application/msword' });
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = makeHtmlFileName("Word_Export") + ".doc";
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}


/* Save HTML helpers */
function makeHtmlFileName(suffix) {
    const schoolEl = document.getElementById("metaSchoolName");
    const locEl = document.getElementById("metaLocation");
    const school = schoolEl && schoolEl.value ? schoolEl.value : "School";
    const loc = locEl && locEl.value ? locEl.value : "Location";
    const dateStr = getCurrentDateISO();
    const raw = `${school} ${loc} ${dateStr} ${suffix}`;
    const safe = raw.trim().replace(/[^a-z0-9]+/gi, "_").replace(/^_+|_+$/g, "");
    return safe + ".html";
}

function saveFinalDraft() {
    expandAllCardsForExport();
    autoNumberObservations();
    syncHeader();
    buildPrintSummary();
    expandAllTextareasForPrint();

        syncFormStateToDomAttributes();
const bodyEl = document.body;
    const prevOnload = bodyEl.getAttribute("onload");
    if (prevOnload) {
        bodyEl.removeAttribute("onload");
    }

    const fullHtml = "<!DOCTYPE html>\n"+ document.documentElement.outerHTML;
    const blob = new Blob([fullHtml], { type: "text/html"});

    if (prevOnload) {
        bodyEl.setAttribute("onload", prevOnload);
    }
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = makeHtmlFileName("final draft");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);
}

function sendToManagement() {
    expandAllCardsForExport();
    autoNumberObservations();
    syncHeader();
    buildPrintSummary();
    expandAllTextareasForPrint();

        syncFormStateToDomAttributes();
const locked = [];
    const editableFields = [];
    const allFields = document.querySelectorAll("input, textarea, select");

    allFields.forEach(el => {
        const isTimeline   = el.classList.contains("timeline-target");
        const isStatus     = el.classList.contains("status-select");
        const isResp       = el.classList.contains("resp-select");
        const isActionPlan = el.classList.contains("action-plan");
        const isAreaJump   = (el.id === "areaJump");

        const editable = (isTimeline || isStatus || isResp || isActionPlan || isAreaJump);

        if (editable) {
            el.classList.remove("locked-field");
            el.classList.add("editable-field");

            const card = el.closest(".observation-card");
            if (card) {
                const riskSel = card.querySelector(".risk-dropdown");
                if (riskSel) {
                    const risk = riskSel.value;
                    if (risk === "High") {
                        el.style.borderColor = "#b91c1c";
                    } else if (risk === "Medium") {
                        el.style.borderColor = "#ca8a04";
                    } else if (risk === "Low") {
                        el.style.borderColor = "#166534";
                    }
                }
            }
            editableFields.push(el);
            return;
        }

        if (el.tagName === "TEXTAREA") {
            locked.push({ el, attr: "readOnly", prev: el.readOnly });
            el.readOnly = true;
        } else if (el.tagName === "INPUT"|| el.tagName === "SELECT") {
            locked.push({ el, attr: "disabled", prev: el.disabled });
            el.disabled = true;
        }
        el.classList.add("locked-field");
    });

    const bodyEl = document.body;
    const prevOnload = bodyEl.getAttribute("onload");
    if (prevOnload) {
        bodyEl.removeAttribute("onload");
    }

    const fullHtml = "<!DOCTYPE html>\n"+ document.documentElement.outerHTML;
    const blob = new Blob([fullHtml], { type: "text/html"});

    if (prevOnload) {
        bodyEl.setAttribute("onload", prevOnload);
    }
    const url = URL.createObjectURL(blob);
    const link = document.createElement("a");
    link.href = url;
    link.download = makeHtmlFileName("for Mngt");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    URL.revokeObjectURL(url);

    locked.forEach(({ el, attr, prev }) => {
        el[attr] = prev;
        el.classList.remove("locked-field");
    });

    editableFields.forEach(el => {
        el.classList.remove("editable-field");
        el.style.borderColor = "";
    });
}

/* Template save / load */
function saveTemplateMeta() {
    try {
        const schoolEl   = document.getElementById("metaSchoolName");
        const locEl      = document.getElementById("metaLocation");
        const periodEl   = document.getElementById("metaPeriod");
        const preparedEl = document.getElementById("metaPreparedBy");

        const template = {
            school:   schoolEl   ? schoolEl.value   : "",
            location: locEl      ? locEl.value      : "",
            period:   periodEl   ? periodEl.value   : "",
            prepared: preparedEl ? preparedEl.value : ""};

        const firstCard = document.querySelector(".observation-card");
        if (firstCard) {
            const typeSel   = firstCard.querySelector(".obs-type-select");
            const riskSel   = firstCard.querySelector(".risk-dropdown");
            const statusSel = firstCard.querySelector(".status-select");
            const respSel   = firstCard.querySelector(".resp-select");
            const dateInput = firstCard.querySelector(".timeline-target");

            template.defaults = {
                type:   typeSel   ? typeSel.value   : "",
                risk:   riskSel   ? riskSel.value   : "",
                status: statusSel ? statusSel.value : "",
                resp:   respSel   ? respSel.value   : "",
                targetDate: dateInput ? dateInput.value : ""};
        }

        localStorage.setItem("irTemplateMeta", JSON.stringify(template));
        alert("Template saved successfully. It will be available for future reports in this browser.");
    } catch (err) {
        console.error("Error saving template:", err);
        alert("Could not save template. Please check console for details.");
    }
}

function loadTemplateMeta(showMessage = true) {
    try {
        const raw = localStorage.getItem("irTemplateMeta");
        if (!raw) {
            if (showMessage) {
                alert("No saved template found. Please fill the header and click 'Save as Template' first.");
            }
            return;
        }

        const template = JSON.parse(raw);

        const schoolEl   = document.getElementById("metaSchoolName");
        const locEl      = document.getElementById("metaLocation");
        const periodEl   = document.getElementById("metaPeriod");
        const preparedEl = document.getElementById("metaPreparedBy");

        if (schoolEl)   schoolEl.value   = template.school   || "";
        if (locEl)      locEl.value      = template.location || "";
        if (periodEl)   periodEl.value   = template.period   || "";
        if (preparedEl) preparedEl.value = template.prepared || "";

        if (template.defaults) {
            const firstCard = document.querySelector(".observation-card");
            if (firstCard) {
                const typeSel   = firstCard.querySelector(".obs-type-select");
                const riskSel   = firstCard.querySelector(".risk-dropdown");
                const statusSel = firstCard.querySelector(".status-select");
                const respSel   = firstCard.querySelector(".resp-select");
                const dateInput = firstCard.querySelector(".timeline-target");

                if (typeSel && template.defaults.type)     typeSel.value     = template.defaults.type;
                if (riskSel && template.defaults.risk)     riskSel.value     = template.defaults.risk;
                if (statusSel && template.defaults.status) statusSel.value   = template.defaults.status;
                if (respSel && template.defaults.resp)     respSel.value     = template.defaults.resp;
                if (dateInput && template.defaults.targetDate) {
                    dateInput.value = template.defaults.targetDate;
                    updateTargetDayLabel(dateInput);
                }

                applyRiskColour(firstCard, riskSel ? riskSel.value : "");
                updateFinancialImpactVisibility(firstCard);
            }
        }

        syncHeader();
        syncLocationToCards();
        autoNumberObservations();

        if (showMessage) {
            alert("Template loaded successfully.");
        }

    } catch (err) {
        console.error("Error loading template:", err);
        alert("Could not load template. Please check console for details.");
    }
}

/* Keyboard shortcuts */
document.addEventListener("keydown", function (e) {
    const key = e.key.toLowerCase();
    const mod = e.ctrlKey || e.metaKey;
    if (mod && e.shiftKey && key === "a") {
        e.preventDefault();
        addObservationCard();
    } else if (mod && e.shiftKey && key === "p") {
        e.preventDefault();
        exportToPDF();
    }
});

/* Area jump dropdown */

function refreshObservationJump() {
    const select = document.getElementById("obsJump");
    if (!select) return;

    const previous = select.value;
    select.innerHTML = "";

    const placeholder = document.createElement("option");
    placeholder.value = "";
    placeholder.textContent = "Jump to Observation";
    select.appendChild(placeholder);

    const cards = document.querySelectorAll(".observation-card");
    cards.forEach(card => {
        const numSpan = card.querySelector(".obs-number span");
        const titleInput = card.querySelector(".obs-title-input");
        const num = numSpan ? numSpan.textContent.trim() : "";
        const title = titleInput ? titleInput.value.trim() : "";
        if (!num || num === "N/A") return;

        let label = num;
        if (title) {
            let t = title;
            if (t.length > 60) t = t.slice(0, 57) + "…";
            label += "– "+ t;
        }

        const opt = document.createElement("option");
        opt.value = num;
        opt.textContent = label;
        select.appendChild(opt);
    });

    if (previous) {
        select.value = previous;
    }
}

function initObservationJump() {
    const select = document.getElementById("obsJump");
    if (!select) return;

    refreshObservationJump();

    select.addEventListener("change", () => {
        const val = select.value;
        if (!val) return;

        const cards = document.querySelectorAll(".observation-card");
        for (const card of cards) {
            const numSpan = card.querySelector(".obs-number span");
            if (numSpan && numSpan.textContent.trim() === val) {
                card.scrollIntoView({ behavior: "smooth", block: "start"});
                break;
            }
        }
    });
}

function scrollToSummary() {
    const el = document.getElementById("printSummary");
    if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "start"});
    }
}

function scrollToDashboard() {
    const el = document.querySelector(".dashboard");
    if (el) {
        el.scrollIntoView({ behavior: "smooth", block: "start"});
    }
}

function initAreaJump() {
    const select = document.getElementById("areaJump");
    if (!select) return;

    select.innerHTML = "";
    AREA_CONFIG.forEach(area => {
        const opt = document.createElement("option");
        opt.value = area.id;
        opt.textContent = area.label;
        select.appendChild(opt);
    });

    select.value = currentAreaKey;
    if (typeof applyAreaBackground === "function") {
        applyAreaBackground(currentAreaKey);
    }

    select.addEventListener("change", () => {
        currentAreaKey = select.value;
        const section = document.querySelector(`.area-section[data-area="${currentAreaKey}"]`);
        if (section) {
            section.scrollIntoView({ behavior: "smooth", block: "start"});
        }
        if (typeof applyAreaBackground === "function") {
            applyAreaBackground(currentAreaKey);
        }
        refreshObservationJump();
    });
}

/* Ensure 4 observation cards in each section on load */
function ensureFourObservationsPerSection() {
    const allSections = document.querySelectorAll(".area-section");
    const globalTemplateCard = document.querySelector(".observation-card");
    if (!globalTemplateCard) return;

    allSections.forEach(section => {
        let cards = section.querySelectorAll(".observation-card");
        let templateCard = cards.length > 0 ? cards[0] : globalTemplateCard;

        while (cards.length < 4) {
            createNewCardInSection(section, templateCard, false);
            cards = section.querySelectorAll(".observation-card");
        }
    });
}

/* Initialise everything */
function initialiseTemplate() {
    const auditInput = document.getElementById("metaAuditDate");
    if (auditInput && !auditInput.value) {
        auditInput.value = getCurrentDateISO();
    }

    document.querySelectorAll(".observation-card").forEach(card => {
        initCard(card);
    });

    addReviewerNotes();

    const schoolInput = document.getElementById("metaSchoolName");
    const locInput = document.getElementById("metaLocation");
    const auditInput2 = document.getElementById("metaAuditDate");
    const prepInput = document.getElementById("metaPreparedBy");

    if (schoolInput) schoolInput.addEventListener("blur", () => { schoolInput.value = toProperCase(schoolInput.value); syncHeader(); });
    if (locInput) locInput.addEventListener("blur", () => { locInput.value = toProperCase(locInput.value); syncLocationToCards(); syncHeader(); });

    if (locInput) locInput.addEventListener("input", syncLocationToCards);
    [schoolInput, locInput, auditInput2, prepInput].forEach(el => {
        if (!el) return;
        const evt = el.type === "date"? "change": "input";
        el.addEventListener(evt, () => {
            syncHeader();
            if (el === auditInput2) {
                const todayISO = getCurrentDateISO();
                const auditDateISO = auditInput2.value || todayISO;
                const minDate = auditDateISO > todayISO ? auditDateISO : todayISO;

                document.querySelectorAll(".observation-card").forEach(card => {
                    const dt = card.querySelector(".timeline-target");
                    if (dt) {
                        dt.min = minDate;
                        if (dt.value && dt.value < minDate) {
                            dt.value = minDate;
                        }
                        updateTargetDayLabel(dt);
                    }
                });
            }
        });
    });

    
    /* Auto-create default blank observations for empty sections.
       Traditional templates keep a minimum set of observation slots per area.
       We keep it at 2 to keep the report compact. */
    const MIN_DEFAULT_CARDS_PER_AREA = 2;
    AREA_CONFIG.forEach(a => {
        const section = document.querySelector(`.area-section[data-area="${a.id}"]`);
        if (!section) return;

        const existing = section.querySelectorAll(".observation-card").length;
        if (existing > 0) return;

        const templateCard = document.querySelector(".observation-card");
        if (!templateCard) return;

        for (let i = 0; i < MIN_DEFAULT_CARDS_PER_AREA; i++) {
            createNewCardInSection(section, templateCard, false);
        }
    });

const dashFilter = document.getElementById("dashboardStatusFilter");
    if (dashFilter) dashFilter.addEventListener("change", recalcSummary);

    const globalCollapseBtn = document.getElementById("btnToggleAllObs");
    if (globalCollapseBtn) {
        globalCollapseBtn.addEventListener("click", function () {
            const allCollapsed = areAllCardsCollapsed();
            setAllCardsCollapsed(!allCollapsed);
            updateGlobalCollapseButtonState();
        });
    }

    initAreaJump();
    initObservationJump();
    updateGlobalCollapseButtonState();
    syncLocationToCards();
    autoNumberObservations();
    syncHeader();
    checkTemplateExpiry();
}

/* Print hook */
window.addEventListener("beforeprint", () => {
    syncFormStateToDomAttributes();
expandAllCardsForExport();
    expandAllTextareasForPrint();
    autoNumberObservations();
    syncHeader();
});

function updateUnifiedJump(){
    const sel = document.getElementById('jumpUnified');
    if(!sel) return;
    sel.innerHTML = '';
    // Add disabled section headers and observation options
    document.querySelectorAll('.area-section').forEach(sec=>{
        const label = sec.querySelector('.area-heading')?.textContent || '';
        const opt = document.createElement('option');
        opt.textContent = '— ' + label + ' —';
        opt.disabled = true;
        sel.appendChild(opt);
        sec.querySelectorAll('.observation-card').forEach(card=>{
            const num = card.querySelector('.obs-number span')?.textContent.trim() || '';
            const title = card.querySelector('.obs-title-input')?.value || '';
            const o = document.createElement('option');
            o.value = num;
            o.textContent = num + '. ' + title;
            sel.appendChild(o);
        });
    });
    sel.onchange = ()=>{
        const val = sel.value;
        const target = [...document.querySelectorAll('.observation-card')]
                        .find(c=>c.querySelector('.obs-number span')?.textContent.trim()===val);
        if(target) target.scrollIntoView({behavior:'smooth'});
    };
}
window.addEventListener('load', updateUnifiedJump);


/* v36 Enhancements Placeholder */

// Auto-risk scoring (simple demo)
function autoRiskScore(card){
  const sev = card.querySelector('.severity')?.value || '';
  const freq = card.querySelector('.frequency')?.value || '';
  let risk='Low';
  if(sev==='High' && freq==='High') risk='High';
  else if(sev==='High' || freq==='High') risk='Medium';
  card.querySelector('.risk-select').value = risk;
}

// Sticky dropdown
window.addEventListener('scroll', ()=>{
  const dd = document.getElementById('jumpUnified');
  if(!dd) return;
  dd.style.position='sticky';
  dd.style.top='0';
  dd.style.zIndex='1000';
});

// Risk color borders
function applyRiskBorders(){
  document.querySelectorAll('.observation-card').forEach(card=>{
    const r = card.querySelector('.risk-select')?.value;
    let col='#4caf50';
    if(r==='High') col='#f44336';
    else if(r==='Medium') col='#ff9800';
    card.style.borderLeft = '6px solid '+col;
  });
}

// Basic validation
function validateCard(card){
  const title = card.querySelector('.obs-title-input');
  if(!title.value.trim()){
    title.style.border='1px solid red';
  } else title.style.border='';
}

// Timeline enhancement placeholder
function enhanceTimeline(){
  document.querySelectorAll('.timeline-row').forEach(row=>{
    row.style.background='linear-gradient(to right, #e3f2fd, #bbdefb)';
  });
}

window.addEventListener('load', ()=>{
  applyRiskBorders();
  enhanceTimeline();
});


/* v37 Enhancements */

// Gantt-style timeline bars
function applyGanttBars(){
  document.querySelectorAll('.timeline-row').forEach(row=>{
    const start = row.dataset.start;
    const end = row.dataset.end;
    if(start && end){
      const bar = document.createElement('div');
      bar.className='gantt-bar';
      bar.style.height='8px';
      bar.style.background='#64b5f6';
      bar.style.borderRadius='4px';
      bar.style.marginTop='4px';
      row.appendChild(bar);
    }
  });
}

// Risk heatmap (simple color intensity)
function applyRiskHeatmap(){
  document.querySelectorAll('.matrix-cell').forEach(cell=>{
    const val = parseInt(cell.textContent) || 0;
    let intensity = Math.min(val*20, 255);
    cell.style.backgroundColor = `rgba(244,67,54,${intensity/255})`;
  });
}

// Reviewer notes (always visible, printable)
function addReviewerNotes(){
  const ICFM_NOTES = [
    "Minutes register was not produced during review. Governance documentation is weak and action closure cannot be evidenced. Implement a formal minutes register and action tracker with responsible person and closure sign-off.",
    "Petty cash physical count was not evidenced as per imprest control. Cash should be tallied periodically and differences investigated. Introduce a cash count sheet with independent verification and defined float limits.",
    "Multiple parallel books increase risk of errors, omissions and inconsistent reporting. Consolidate to a single source of truth and document controls for data entry, review, and reporting.",
    "Dawat-e-Hadiyah donation receipts should be reflected in the budget for transparent planning and utilisation tracking. Verify receipts, ledger postings and budget presentation consistency.",
    "Long outstanding staff advances indicate weak recovery control. Obtain an ageing, approvals, and a recovery plan with payroll deductions or timelines approved by management.",
    "Bank reconciliation was not evidenced/updated. Reconcile monthly, investigate old reconciling items, and ensure independent review and sign-off.",
    "Qardan Hasana register/supporting documents were not available though balances are reflected in books. Maintain borrower-wise register with approvals, disbursement proof, recovery schedule and confirmations.",
    "Inter-entity balances (School/Society/Madrasa/Construction) do not match. Prepare entity-wise reconciliations, confirm counter-party balances, and pass corrective entries with approvals.",
    "Dormant bank accounts increase risk of misuse and control gaps. Close accounts not required and recover unused instruments/online credentials; document periodic review of account status.",
    "Accounting basis disclosure is inconsistent. Confirm the approved basis (cash or mercantile) and align policy notes and reporting consistently across the report."];

  document.querySelectorAll('.observation-card').forEach((card, idx)=>{
    if(!card.querySelector('.review-notes-wrap')){
      const wrap = document.createElement('div');
      wrap.className = 'review-notes-wrap';
      wrap.innerHTML = `
        <div class="field-block reviewer-block">
          <div class="field-label">Reviewer Notes</div>
          <textarea class="review-notes"placeholder="Reviewer notes"></textarea>
        </div>
      `;
      // Place reviewer notes at the bottom of the observation card (visible only when collapsed via CSS)
      const body = card.querySelector('.obs-body');
      if(body){
        body.insertAdjacentElement('afterend', wrap);
      } else {
        card.appendChild(wrap);
      }
      const ta = wrap.querySelector('textarea');
      if(ta){
        autoResizeTextarea(ta);
        ta.addEventListener('input', ()=>autoResizeTextarea(ta));
      }
    }
    const inICFM = !!card.closest('#area-ICFM');
    const ta = card.querySelector('.review-notes');
    if(inICFM && ta && !ta.value){
      ta.value = ICFM_NOTES[idx] || "";
      autoResizeTextarea(ta);
    }
  });
}


// Load enhancements
window.addEventListener('load', ()=>{
  applyGanttBars();
  applyRiskHeatmap();
  addReviewerNotes();
});


/* v38 Enhancements */

// Auto-refresh Unified Jump when observations change
function initObservationWatcher(){
  const container = document.body;
  if(!container) return;
  const observer = new MutationObserver((mutations)=>{
    let shouldUpdate = false;
    mutations.forEach(m=>{
      if([...m.addedNodes].some(n=>n.classList && n.classList.contains('observation-card')) ||
         [...m.removedNodes].some(n=>n.classList && n.classList.contains('observation-card'))){
        shouldUpdate = true;
      }
    });
    if(shouldUpdate && typeof updateUnifiedJump === 'function'){
      updateUnifiedJump();
    }
  });
  observer.observe(container, {childList:true, subtree:true});
}

window.addEventListener('load', ()=>{
  initObservationWatcher();
  if(typeof updateUnifiedJump === 'function') updateUnifiedJump();
});


/* v39 Enhancements */

// Update Jump dropdown when observation titles change
function initTitleChangeWatcher(){
  document.addEventListener('input', (e)=>{
    if(e.target.classList && e.target.classList.contains('obs-title-input')){
      if(typeof updateUnifiedJump === 'function') updateUnifiedJump();
    }
  });
}

// Unfreeze jump to section in save to management
function enableJumpInSave(){
  const dd = document.getElementById('jumpUnified');
  if(dd) dd.disabled = false;
}

window.addEventListener('load', ()=>{
  initTitleChangeWatcher();
  enableJumpInSave();
});


/* v40 – Section Progress Bar */

/**
 * For each area-section, compute:
 *   total observations (excluding NA)
 *   closed observations
 * and render a small progress bar under the heading.
 */
function updateSectionProgress() {
    document.querySelectorAll('.area-section').forEach(section => {
        const cards = Array.from(section.querySelectorAll('.observation-card'));
        if (!cards.length) return;

        let total = 0;
        let closed = 0;

        cards.forEach(card => {
            const na = card.querySelector('.na-checkbox');
            if (na && na.checked) return; // skip NA

            const stSel = card.querySelector('.status-select');
            if (!stSel) return;

            total++;
            if (stSel.value === 'Closed') closed++;
        });

        // Ensure progress wrapper exists
        let heading = section.querySelector('.area-heading');
        if (!heading) return;

        let wrapper = section.querySelector('.section-progress-wrapper');
        if (!wrapper) {
            wrapper = document.createElement('div');
            wrapper.className = 'section-progress-wrapper';

            const barOuter = document.createElement('div');
            barOuter.className = 'section-progress-bar-outer';

            const barInner = document.createElement('div');
            barInner.className = 'section-progress-bar-inner';

            barOuter.appendChild(barInner);

            const label = document.createElement('div');
            label.className = 'section-progress-label';

            wrapper.appendChild(barOuter);
            wrapper.appendChild(label);

            heading.insertAdjacentElement('afterend', wrapper);
        }

        const barInner = wrapper.querySelector('.section-progress-bar-inner');
        const label = wrapper.querySelector('.section-progress-label');

        if (!total) {
            if (barInner) barInner.style.width = '0%';
            if (label) label.textContent = 'No active observations in this section';
            return;
        }

        const pct = Math.round((closed / total) * 100);
        if (barInner) barInner.style.width = pct + '%';
        if (label) {
            label.textContent = `Closed ${closed} of ${total} observations (${pct}%)`;
        }
    });
}

// Wrap existing recalcSummary to also refresh section progress
if (typeof recalcSummary === 'function') {
    (function () {
        const __origRecalcSummary = recalcSummary;
        recalcSummary = function () {
            __origRecalcSummary();
            updateSectionProgress();
        };
    })();
}

// Initial run on load (in case someone doesn't click Refresh Dashboard)
window.addEventListener('load', function () {
    updateSectionProgress();
});


/* v40B – Enhanced Section & Overall Progress */
function updateSectionProgress() {
    document.querySelectorAll('.area-section').forEach(section => {
        const cards = Array.from(section.querySelectorAll('.observation-card'));
        if (!cards.length) return;

        let total = 0;
        let closed = 0;
        let highOpen = 0;

        cards.forEach(card => {
            const na = card.querySelector('.na-checkbox');
            if (na && na.checked) return;
            const stSel = card.querySelector('.status-select');
            const riskSel = card.querySelector('.risk-dropdown');
            if (!stSel) return;

            total++;
            if (stSel.value === 'Closed') closed++;
            else if (riskSel && riskSel.value === 'High') highOpen++;
        });

        const heading = section.querySelector('.area-heading');
        if (!heading) return;

        let wrapper = section.querySelector('.section-progress-wrapper');
        if (!wrapper) {
            wrapper = document.createElement('div');
            wrapper.className = 'section-progress-wrapper';

            const barOuter = document.createElement('div');
            barOuter.className = 'section-progress-bar-outer';

            const barInner = document.createElement('div');
            barInner.className = 'section-progress-bar-inner';
            barOuter.appendChild(barInner);

            const label = document.createElement('div');
            label.className = 'section-progress-label';

            wrapper.appendChild(barOuter);
            wrapper.appendChild(label);
            heading.insertAdjacentElement('afterend', wrapper);
        }

        const barInner = wrapper.querySelector('.section-progress-bar-inner');
        const label = wrapper.querySelector('.section-progress-label');

        wrapper.classList.remove('low-progress', 'mid-progress');

        if (!total) {
            if (barInner) barInner.style.width = '0%';
            if (label) label.textContent = 'No active observations in this section';
            return;
        }

        const pct = Math.round((closed / total) * 100);
        if (barInner) barInner.style.width = pct + '%';

        if (pct < 30) wrapper.classList.add('low-progress');
        else if (pct < 60) wrapper.classList.add('mid-progress');

        let txt = `Closed ${closed} of ${total} observations (${pct}%)`;
        if (highOpen > 0) txt += ` | High-risk open: ${highOpen}`;
        label.textContent = txt;
    });

    updateOverallProgress();
}

function updateOverallProgress() {
    const allCards = Array.from(document.querySelectorAll('.observation-card'));
    let total = 0;
    let closed = 0;

    allCards.forEach(card => {
        const na = card.querySelector('.na-checkbox');
        if (na && na.checked) return;
        const stSel = card.querySelector('.status-select');
        if (!stSel) return;
        total++;
        if (stSel.value === 'Closed') closed++;
    });

    let wrapper = document.querySelector('.overall-progress-wrapper');
    if (!wrapper) {
        const header = document.querySelector('.header-row');
        if (!header) return;
        wrapper = document.createElement('div');
        wrapper.className = 'overall-progress-wrapper';

        const title = document.createElement('div');
        title.textContent = 'Overall Closure Progress';

        const barOuter = document.createElement('div');
        barOuter.className = 'overall-progress-bar-outer';

        const barInner = document.createElement('div');
        barInner.className = 'overall-progress-bar-inner';
        barOuter.appendChild(barInner);

        const label = document.createElement('div');
        label.className = 'section-progress-label';

        wrapper.appendChild(title);
        wrapper.appendChild(barOuter);
        wrapper.appendChild(label);
        header.insertAdjacentElement('afterend', wrapper);
    }

    const barInner = wrapper.querySelector('.overall-progress-bar-inner');
    const label = wrapper.querySelector('.section-progress-label');

    if (!total) {
        if (barInner) barInner.style.width = '0%';
        if (label) label.textContent = 'No active observations in this report';
        return;
    }

    const pct = Math.round((closed / total) * 100);
    if (barInner) barInner.style.width = pct + '%';
    label.textContent = `Closed ${closed} of ${total} observations (${pct}%) overall`;
}

(function () {
    if (window.__recalcSummaryWrappedV40B) return;
    window.__recalcSummaryWrappedV40B = true;

    if (typeof recalcSummary === 'function') {
        const __orig = recalcSummary;
        recalcSummary = function () {
            __orig();
            updateSectionProgress();
        };
    }
})();

window.addEventListener('load', function () {
    updateSectionProgress();
});


/* Management-View Mode & Ageing Tracker & Export Tweaks */

/* Toggle Management View (clean, printable-friendly) */
function toggleMgmtView() {
    const body = document.body;
    const btn = document.getElementById('btnMgmtView');
    const isOn = body.classList.toggle('mgmt-view');
    if (btn) {
        btn.textContent = isOn ? 'Detailed View' : 'Management View';
    }
}

/* Print behaviour:
   - Do NOT force mgmt-view for all printing (it hides obs-body and can drop Management Response in PDF).
   - If you want a management-only print, set window.__printMgmtView = true before calling window.print().
*/
window.__printMgmtView = false;
window.addEventListener('beforeprint', function () {
    if (window.__printMgmtView) document.body.classList.add('mgmt-view');
});
window.addEventListener('afterprint', function () {
    if (window.__printMgmtView) document.body.classList.remove('mgmt-view');
    window.__printMgmtView = false;
});
/* Section-wise Ageing Tracker */
function updateSectionAgeing() {
    const tbody = document.getElementById('sectionAgeingBody');
    if (!tbody || (typeof AREA_CONFIG === 'undefined')) return;

    tbody.innerHTML = '';
    const today = new Date();
    const today0 = new Date(today.getFullYear(), today.getMonth(), today.getDate());

    let totOpen = 0, totInProg = 0, totClosed = 0, totOverdue = 0, totAll = 0;

    // Matrix: Rows = Sections, Columns = Open / In-Progress / Closed / Overdue
    AREA_CONFIG.forEach(cfg => {
        const section = document.querySelector('.area-section[data-area="' + cfg.id + '"]');

        let openCount = 0;
        let inProgCount = 0;
        let closedCount = 0;
        let overdueCount = 0;

        if (section) {
            const cards = Array.from(section.querySelectorAll('.observation-card'));
            cards.forEach(card => {
                const na = card.querySelector('.na-checkbox');
                if (na && na.checked) return;

                const statusSel = card.querySelector('.status-select');
                let statusVal = statusSel ? (statusSel.value || '') : '';

                const targetInp = card.querySelector('.timeline-target');
                const targetVal = targetInp ? targetInp.value : '';

                // If date is missing, treat as Open by default
                if (!statusVal) statusVal = 'Open';
                if (!targetVal && (!statusSel || !statusSel.value)) statusVal = 'Open';

                if (statusVal === 'Open') openCount++;
                else if (statusVal === 'In-Progress') inProgCount++;
                else if (statusVal === 'Closed') closedCount++;
                else openCount++;

                if (statusVal !== 'Closed' && targetVal) {
                    const tDate = new Date(targetVal + 'T00:00:00');
                    if (!isNaN(tDate) && tDate < today0) overdueCount++;
                }
            });
        }

        totOpen += openCount;
        totInProg += inProgCount;
        totClosed += closedCount;
        totOverdue += overdueCount;

        const rowTotal = openCount + inProgCount + closedCount + overdueCount;
        totAll += rowTotal;

        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td>${cfg.label}</td>
          <td>${openCount}</td>
          <td>${inProgCount}</td>
          <td>${closedCount}</td>
          <td>${overdueCount}</td>
          <td>${rowTotal}</td>
        `;
        tbody.appendChild(tr);
    });

    // Single Grand Total at end
    const trTot = document.createElement('tr');
    trTot.innerHTML = `
      <td><b>Grand Total</b></td>
      <td><b>${totOpen}</b></td>
      <td><b>${totInProg}</b></td>
      <td><b>${totClosed}</b></td>
      <td><b>${totOverdue}</b></td>
      <td><b>${totAll}</b></td>
    `;
    tbody.appendChild(trTot);
}

/* Extend progress update to also refresh ageing tracker & overall bar */
(function () {
    if (window.__wrapUpdateSectionProgressForAgeing) return;
    window.__wrapUpdateSectionProgressForAgeing = true;

    if (typeof updateSectionProgress === 'function') {
        const __origUSP = updateSectionProgress;
        updateSectionProgress = function () {
            __origUSP();
            updateSectionAgeing();
        };
    } else {
        // If not defined yet, at least call ageing once on load
        window.addEventListener('load', updateSectionAgeing);
    }
})();

/* Hide reviewer notes during export (PDF/Word) */
(function () {
    if (window.__wrappedExportExpand) return;
    window.__wrappedExportExpand = true;

    if (typeof expandAllCardsForExport === 'function') {
        const __origExpand = expandAllCardsForExport;
        expandAllCardsForExport = function () {
            const notes = document.querySelectorAll('.review-notes');
            notes.forEach(el => {
                el.setAttribute('data-prev-display', el.style.display || '');
                el.style.display = 'none';
            });
            try {
                __origExpand();
            } finally {
                notes.forEach(el => {
                    const prev = el.getAttribute('data-prev-display');
                    el.style.display = prev;
                    el.removeAttribute('data-prev-display');
                });
            }
        };
    }
})();

/* Initial ageing calculation on load */
window.addEventListener('load', function () {
    updateSectionAgeing();
});

</script>
</body>
</html>
